<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagnostic - Biblioth√®que Al-Kawthar</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: #f4f7f9; color: #333; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; background: white; border-radius: 10px; padding: 30px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        h1 { color: #005f73; text-align: center; border-bottom: 2px solid #0a9396; padding-bottom: 10px; margin-bottom: 20px; }
        .status-box { padding: 15px; margin: 15px 0; border-radius: 8px; border-left: 5px solid; font-size: 1.1em; display: flex; align-items: center; gap: 15px; }
        .status-box.loading { background: #e3f2fd; border-color: #2196F3; }
        .status-box.success { background: #e8f5e9; border-color: #4CAF50; }
        .status-box.error { background: #ffebee; border-color: #f44336; }
        .status-box.warning { background: #fff3e0; border-color: #ff9800; }
        .icon { font-size: 1.5em; }
        pre { background: #2d333b; color: #adbac7; padding: 15px; border-radius: 5px; overflow-x: auto; margin-top: 10px; font-family: "SF Mono", "Consolas", monospace; }
        .btn { display: inline-block; background: #005f73; color: white; border: none; padding: 12px 24px; border-radius: 5px; cursor: pointer; font-size: 16px; margin-top: 20px; text-decoration: none; }
        .btn:hover { background: #0a9396; }
        .instructions { background: #fff3e0; border: 1px solid #ff9800; padding: 20px; border-radius: 8px; margin-top: 30px; }
        .instructions h3 { margin-top: 0; color: #af6a00; }
        .instructions li { margin-bottom: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Diagnostic du Syst√®me de Biblioth√®que</h1>
        <div id="results"></div>
        <div style="text-align: center;">
            <a href="#" class="btn" onclick="runDiagnostic()">üîÑ Relancer les tests</a>
            <a href="/" class="btn">üè† Retour √† l'accueil</a>
        </div>
        <div class="instructions">
            <h3>üö® Que faire si les tests √©chouent ?</h3>
            <p>Si le test de connexion √† MongoDB √©choue, suivez ces √©tapes :</p>
            <ol>
                <li>Allez sur votre tableau de bord <a href="https://vercel.com" target="_blank">Vercel</a>.</li>
                <li>S√©lectionnez votre projet `library-alkawthar`.</li>
                <li>Allez dans l'onglet <strong>Settings</strong> &rarr; <strong>Environment Variables</strong>.</li>
                <li>V√©rifiez qu'il existe une variable nomm√©e <code>MONGODB_URI</code>.</li>
                <li>Si elle n'existe pas, cr√©ez-la. Collez votre cha√Æne de connexion MongoDB compl√®te dans le champ "Value".</li>
                <li><strong>TR√àS IMPORTANT :</strong> Apr√®s avoir ajout√© ou modifi√© la variable, vous devez red√©ployer votre projet. Allez dans l'onglet <strong>Deployments</strong>, trouvez le dernier d√©ploiement, cliquez sur les trois points (‚ãÆ) et s√©lectionnez <strong>Redeploy</strong>.</li>
            </ol>
        </div>
    </div>

    <script>
        const resultsDiv = document.getElementById('results');

        function addResult(status, icon, title, message, data = null) {
            const div = document.createElement('div');
            div.className = `status-box ${status}`;
            let html = `<div class="icon">${icon}</div><div><strong>${title}</strong><br>${message}</div>`;
            if (data) {
                html += `<pre>${JSON.stringify(data, null, 2)}</pre>`;
            }
            div.innerHTML = html;
            resultsDiv.appendChild(div);
        }

        async function runDiagnostic() {
            resultsDiv.innerHTML = '';
            addResult('loading', '‚è≥', 'Test en cours...', 'Veuillez patienter.');

            // Test 1: Connexion √† l'API
            try {
                const response = await fetch('/api');
                const data = await response.json();
                resultsDiv.innerHTML = ''; // Nettoyer le message de chargement

                if (response.ok) {
                    addResult('success', '‚úÖ', 'Test 1: Connexion API', 'L\'API est accessible et r√©pond correctement.', data);

                    // Test 1.1: Statut de la base de donn√©es
                    if (data.database && data.database.connected) {
                        addResult('success', '‚úÖ', 'Test 2: Connexion √† MongoDB', `La base de donn√©es est bien connect√©e. ${data.database.booksCount} livres trouv√©s.`, data.database);
                    } else {
                        addResult('error', '‚ùå', 'Test 2: Connexion √† MongoDB', "√âCHEC CRITIQUE : L'API fonctionne mais n'est PAS connect√©e √† la base de donn√©es. V√©rifiez votre variable d'environnement <code>MONGODB_URI</code> sur Vercel !", data.database);
                    }
                } else {
                    addResult('error', '‚ùå', 'Test 1: Connexion API', `L'API a retourn√© une erreur: ${response.status}`, data);
                }
            } catch (error) {
                resultsDiv.innerHTML = '';
                addResult('error', '‚ùå', 'Test 1: Connexion API', `Impossible de contacter le serveur sur /api. V√©rifiez la configuration de Vercel (vercel.json) et les logs du serveur. Erreur: ${error.message}`);
            }
        }

        window.addEventListener('DOMContentLoaded', runDiagnostic);
    </script>
</body>
</html>
