<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-lang-key="title">مكتبة الكوثر</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
    <!-- PAGE DE CONNEXION (INCHANGÉE) -->
    <div id="login-page">
         <div class="language-switcher standalone"><button class="lang-btn" data-lang="ar">العربية</button><button class="lang-btn" data-lang="fr">Français</button><button class="lang-btn" data-lang="en">English</button></div>
        <div class="login-container">
            <img src="https://lh3.googleusercontent.com/d/1lQ3Babrs3Wgv4rakVmkK0oCWcM0cTKPK" alt="Logo Alkawthar" class="logo">
            <h1 data-lang-key="welcome_title">مرحباً بكم في مكتبة مدارس الكوثر العالمية</h1>
            <p class="welcome-subtitle" data-lang-key="welcome_subtitle">الرجاء إدخال بيانات الاعتماد الخاصة بك للوصول إلى لوحة التحكم.</p>
            <form id="login-form">
                <div class="input-group"><i class="fas fa-user"></i><input type="text" id="username" required data-lang-key-placeholder="username_label" value="Alkawthar@30"></div>
                <div class="input-group"><i class="fas fa-lock"></i><input type="password" id="password" required data-lang-key-placeholder="password_label" value="Alkawthar@30"></div>
                <button type="submit" class="btn" data-lang-key="login_btn">تسجيل الدخول</button>
                <p id="login-error" class="error-message"></p>
            </form>
        </div>
    </div>

    <!-- TABLEAU DE BORD -->
    <div id="dashboard-page" style="display:none;">
        <header>
             <div class="logo-header"><i class="fas fa-book-open"></i><h1 data-lang-key="dashboard_title">لوحة تحكم مكتبة الكوثر</h1></div>
             <div class="header-controls">
                <div class="language-switcher"><button class="lang-btn" data-lang="ar">AR</button><button class="lang-btn" data-lang="fr">FR</button><button class="lang-btn" data-lang="en">EN</button></div>
                <div class="header-user"><span data-lang-key="school_name">مدارس الكوثر العالمية</span><i class="fas fa-school"></i></div>
                <button id="logout-btn" class="btn-logout"><i class="fas fa-sign-out-alt"></i><span data-lang-key="logout_btn_title">تسجيل الخروج</span></button>
            </div>
        </header>
        <main class="container">
            <!-- Stats & Prêts (Modifié) -->
            <section class="card stats-card animated">
                 <h2 data-lang-key="stats_title"><i class="fas fa-chart-pie"></i> إحصائيات المكتبة</h2>
                <div class="stats-container">
                    <div class="stat-item"><i class="fas fa-book"></i><div><span id="total-books-stat">0</span><p data-lang-key="total_books">إجمالي الكتب</p></div></div>
                    <div class="stat-item"><i class="fas fa-hand-holding-heart"></i><div><span id="loaned-books-stat">0</span><p data-lang-key="loaned_books">الكتب المعارة</p></div></div>
                    <div class="stat-item"><i class="fas fa-check-circle"></i><div><span id="available-books-stat">0</span><p data-lang-key="available_books">الكتب المتاحة</p></div></div>
                </div>
                 <button id="view-loans-btn" class="btn btn-secondary" style="margin-top: 1rem;"><i class="fas fa-user-graduate"></i> <span data-lang-key="view_loans_btn">عرض الطلاب المستعيرين</span></button>
            </section>
            
            <div class="columns">
                 <!-- Scanner (Inchangé) -->
                <section class="card barcode-section animated">
                    <h2 data-lang-key="scanner_title"><i class="fas fa-barcode"></i> بحث سريع بالباركود</h2>
                    <div class="form-group"><label for="isbn-scanner" data-lang-key="scanner_label">امسح ISBN الكتاب هنا:</label><input type="text" id="isbn-scanner" data-lang-key-placeholder="scanner_placeholder"></div>
                    <div id="book-details-view" class="book-details-view"><p class="placeholder" data-lang-key="scanner_instruction">الرجاء مسح كتاب ضوئياً لعرض معلوماته.</p></div>
                </section>
                 <!-- Excel (Inchangé) -->
                <section class="card animated">
                    <h2 data-lang-key="excel_upload_title"><i class="fas fa-file-excel"></i> إضافة عبر ملف Excel</h2>
                    <p data-lang-key="excel_instruction">اختر ملف (.xlsx) بالأعمدة: Title, ISBN, QTY, Subject, level, language, Corner name, Corner number</p>
                    <input type="file" id="excel-file-input" class="file-input" accept=".xlsx, .xls, .csv">
                    <label for="excel-file-input" class="btn btn-secondary file-label" data-lang-key="choose_file_btn"><i class="fas fa-upload"></i> اختر ملف...</label>
                    <button id="upload-excel-btn" class="btn" data-lang-key="upload_btn">رفع الملف</button>
                    <div id="upload-status"></div>
                </section>
            </div>
            
            <!-- NOUVEAU: Recherche d'historique par élève -->
            <section class="card animated">
                <h2 data-lang-key="student_history_title"><i class="fas fa-history"></i> historique de l'élève</h2>
                <form id="student-history-form">
                    <div class="form-group">
                        <label for="student-history-search" data-lang-key="student_name_label">اسم الطالب</label>
                        <input type="text" id="student-history-search" required data-lang-key-placeholder="student_history_placeholder">
                    </div>
                    <button type="submit" class="btn btn-secondary"><i class="fas fa-search"></i> <span data-lang-key="search_btn">Chercher</span></button>
                </form>
            </section>

            <!-- Recherche d'inventaire -->
            <section class="card animated">
                <h2 data-lang-key="search_book_title"><i class="fas fa-search"></i> البحث في المخزون</h2>
                <div class="form-group"><input type="text" id="search-input" data-lang-key-placeholder="search_placeholder" placeholder="ابحث بالعنوان أو ISBN..."></div>
                <div class="table-container">
                    <table id="books-table">
                        <thead><tr><th data-lang-key="isbn_col">ISBN</th><th data-lang-key="title_col">العنوان</th><th data-lang-key="corner_name_col">اسم الركن</th><th data-lang-key="corner_num_col">رقم الركن</th><th data-lang-key="availability_col">الإتاحة</th><th data-lang-key="actions_col">الإجراءات</th></tr></thead>
                        <tbody id="books-table-body"></tbody>
                    </table>
                </div>
            </section>
            
             <!-- Ajout Manuel & Gestion des Prêts (Inchangés) -->
            <div class="columns">
                <section class="card animated">
                    <h2 data-lang-key="add_book_title"><i class="fas fa-plus-circle"></i> تسجيل كتاب جديد يدوياً</h2>
                    <form id="add-book-form">
                         <div class="form-group"><label for="new-title" data-lang-key="book_title_label">عنوان الكتاب</label><input type="text" id="new-title" required></div>
                        <div class="form-group"><label for="new-isbn">ISBN</label><input type="text" id="new-isbn" required></div>
                        <div class="form-group"><label for="new-quantity" data-lang-key="quantity_label">الكمية</label><input type="number" id="new-quantity" required min="1" value="1"></div>
                        <div class="form-group"><label for="new-subject" data-lang-key="subject_label">المادة</label><input type="text" id="new-subject"></div>
                        <div class="form-group"><label for="new-level" data-lang-key="level_label">المستوى</label><input type="text" id="new-level"></div>
                        <div class="form-group"><label for="new-language" data-lang-key="language_label">اللغة</label><input type="text" id="new-language"></div>
                        <div class="form-group"><label for="new-corner-name" data-lang-key="corner_name_label">اسم الركن</label><input type="text" id="new-corner-name" required></div>
                        <div class="form-group"><label for="new-corner-number" data-lang-key="corner_num_label">رقم الركن</label><input type="text" id="new-corner-number" required></div>
                        <button type="submit" class="btn" data-lang-key="save_book_btn">حفظ الكتاب</button>
                    </form>
                </section>
                <section class="card animated">
                    <h2 data-lang-key="manage_loan_title"><i class="fas fa-hand-holding-heart"></i> إدارة الإعارة</h2>
                    <form id="loan-form">
                        <div class="form-group"><label for="loan-isbn">ISBN الكتاب</label><input type="text" id="loan-isbn" required></div>
                        <div class="form-group auto-filled"><label data-lang-key="book_title_label">عنوان الكتاب</label><p id="loan-book-title">-</p></div>
                        <hr>
                        <div class="form-group"><label for="student-name" data-lang-key="student_name_label">اسم الطالب</label><input type="text" id="student-name" required></div>
                        <div class="form-group"><label for="loan-date" data-lang-key="loan_date_label">تاريخ الإعارة</label><input type="date" id="loan-date" required></div>
                        <div class="form-group"><label for="return-date" data-lang-key="return_date_label">تاريخ التسليم</label><input type="date" id="return-date" required></div>
                        <button type="submit" class="btn" data-lang-key="loan_book_btn">إعارة الكتاب</button>
                    </form>
                </section>
            </div>
        </main>
        <footer><p data-lang-key="footer_text">&copy; 2025 مدارس الكوثر العالمية - جميع الحقوق محفوظة.</p></footer>
    </div>
    
    <!-- MODALES -->
    <div id="modal-overlay" class="modal-overlay" style="display:none;">
        <!-- Modale des prêts -->
        <div id="loans-modal" class="modal">
            <button class="close-modal-btn">&times;</button>
            <h2 data-lang-key="loaned_books_list_title">قائمة الكتب المعارة</h2>
            <div class="form-group"><input type="text" id="loan-search-input" data-lang-key-placeholder="loan_search_placeholder" placeholder="ابحث بالاسم، العنوان، أو امسح ISBN..."></div>
            <div id="loans-modal-content" class="table-container"></div>
        </div>
        <!-- Modale de modification -->
        <div id="edit-modal" class="modal">
            <button class="close-modal-btn">&times;</button>
            <h2 data-lang-key="edit_book_title">تعديل معلومات الكتاب</h2>
            <form id="edit-book-form">
                <input type="hidden" id="edit-original-isbn">
                <div class="form-group"><label for="edit-title" data-lang-key="book_title_label">عنوان الكتاب</label><input type="text" id="edit-title" required></div>
                <div class="form-group"><label for="edit-isbn">ISBN</label><input type="text" id="edit-isbn" required></div>
                <div class="form-group"><label for="edit-quantity" data-lang-key="quantity_label">الكمية الإجمالية</label><input type="number" id="edit-quantity" required min="1"></div>
                <div class="form-group"><label for="edit-subject" data-lang-key="subject_label">المادة</label><input type="text" id="edit-subject"></div>
                <div class="form-group"><label for="edit-level" data-lang-key="level_label">المستوى</label><input type="text" id="edit-level"></div>
                <div class="form-group"><label for="edit-language" data-lang-key="language_label">اللغة</label><input type="text" id="edit-language"></div>
                <div class="form-group"><label for="edit-corner-name" data-lang-key="corner_name_label">اسم الركن</label><input type="text" id="edit-corner-name" required></div>
                <div class="form-group"><label for="edit-corner-number" data-lang-key="corner_num_label">رقم الركن</label><input type="text" id="edit-corner-number" required></div>
                <button type="submit" class="btn" data-lang-key="save_changes_btn">حفظ التغييرات</button>
            </form>
        </div>
        <!-- NOUVEAU: Modale d'historique -->
        <div id="history-modal" class="modal">
            <button class="close-modal-btn">&times;</button>
            <h2 id="history-modal-title">Historique</h2>
            <div id="history-modal-content" class="table-container"></div>
        </div>
    </div>
    
    <script>
    // TOUT VOTRE JAVASCRIPT EST ICI (MODIFIÉ)
    document.addEventListener('DOMContentLoaded', () => {
        // --- VARIABLES GLOBALES ET ÉLÉMENTS DU DOM ---
        let allBooks = [];
        let allLoans = [];

        // Sélection des éléments (la plupart sont identiques)
        const loginPage = document.getElementById('login-page'),
              dashboardPage = document.getElementById('dashboard-page'),
              loginForm = document.getElementById('login-form'),
              loginError = document.getElementById('login-error'),
              logoutBtn = document.getElementById('logout-btn'),
              // ... autres sélecteurs
              viewLoansBtn = document.getElementById('view-loans-btn'),
              modalOverlay = document.getElementById('modal-overlay'),
              loansModal = document.getElementById('loans-modal'),
              editModal = document.getElementById('edit-modal'),
              historyModal = document.getElementById('history-modal'), // Nouveau
              historyModalTitle = document.getElementById('history-modal-title'), // Nouveau
              historyModalContent = document.getElementById('history-modal-content'), // Nouveau
              studentHistoryForm = document.getElementById('student-history-form'), // Nouveau
              addBookForm = document.getElementById('add-book-form'),
              loanForm = document.getElementById('loan-form'),
              editBookForm = document.getElementById('edit-book-form'),
              searchInput = document.getElementById('search-input'),
              booksTableBody = document.getElementById('books-table-body'),
              uploadExcelBtn = document.getElementById('upload-excel-btn');


        // --- FONCTIONS DE COMMUNICATION API ---
        const apiFetch = async (url, options = {}) => {
            try {
                const response = await fetch(`/api${url}`, options);
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || `Erreur HTTP: ${response.status}`);
                }
                if (response.status === 204) return; // No Content
                return response.json();
            } catch (error) {
                console.error(`Erreur API pour ${url}:`, error);
                alert(`Une erreur est survenue: ${error.message}`);
                throw error;
            }
        };

        const fetchAllData = async () => {
            [allBooks, allLoans] = await Promise.all([
                apiFetch('/books'),
                apiFetch('/loans')
            ]);
            initializeDashboard();
        };

        // --- FONCTIONS DE MISE À JOUR DE L'INTERFACE ---
        const updateStats = () => {
            const totalCopies = allBooks.reduce((sum, book) => sum + book.totalCopies, 0);
            const loanedCopies = allBooks.reduce((sum, book) => sum + book.loanedCopies, 0);
            document.getElementById('total-books-stat').textContent = totalCopies;
            document.getElementById('loaned-books-stat').textContent = loanedCopies;
            document.getElementById('available-books-stat').textContent = totalCopies - loanedCopies;
        };
        
        const renderTable = (bookList) => {
            booksTableBody.innerHTML = '';
            // ... (logique de langue identique)
             const currentLang = document.documentElement.lang; const availabilityTexts = { ar: "متاح", fr: "disponible(s)", en: "available" }; const actionsTexts = { ar: { edit: "تعديل", delete: "حذف", history: "Historique" }, fr: { edit: "Modifier", delete: "Supprimer", history: "Historique" }, en: { edit: "Edit", delete: "Delete", history: "History" } };
            
            bookList.forEach(book => {
                const availableCopies = book.totalCopies - book.loanedCopies;
                const availabilityClass = availableCopies > 0 ? 'status-available' : 'status-unavailable';
                const availabilityText = `${availableCopies} / ${book.totalCopies} ${availabilityTexts[currentLang]}`;
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${book.isbn}</td>
                    <td>${book.title}</td>
                    <td>${book.cornerName || ''}</td>
                    <td>${book.cornerNumber || ''}</td>
                    <td><span class="${availabilityClass}">${availabilityText}</span></td>
                    <td class="actions-cell">
                        <button class="btn-action btn-history" title="${actionsTexts[currentLang].history}" data-isbn="${book.isbn}" data-title="${book.title}"><i class="fas fa-history"></i></button>
                        <button class="btn-action btn-edit" title="${actionsTexts[currentLang].edit}" data-isbn="${book.isbn}"><i class="fas fa-edit"></i></button>
                        <button class="btn-action btn-delete" title="${actionsTexts[currentLang].delete}" data-isbn="${book.isbn}" data-title="${book.title}"><i class="fas fa-trash"></i></button>
                    </td>`;
                
                row.querySelector('.btn-history').addEventListener('click', (e) => showBookHistory(e.currentTarget.dataset.isbn, e.currentTarget.dataset.title));
                row.querySelector('.btn-edit').addEventListener('click', (e) => openEditModal(e.currentTarget.dataset.isbn));
                row.querySelector('.btn-delete').addEventListener('click', (e) => deleteBook(e.currentTarget.dataset.isbn, e.currentTarget.dataset.title));
                
                booksTableBody.appendChild(row);
            });
        };

        const initializeDashboard = () => {
            updateStats();
            renderTable(allBooks);
        };
        
        const displayLoans = (searchTerm = '') => {
            // ... (logique de filtrage et affichage identique)
             const lowerCaseSearchTerm = searchTerm.toLowerCase(); const filteredLoans = allLoans.filter(loan => { const book = allBooks.find(b => b.isbn === loan.isbn); return loan.studentName.toLowerCase().includes(lowerCaseSearchTerm) || (book && book.title.toLowerCase().includes(lowerCaseSearchTerm)) || loan.isbn.includes(lowerCaseSearchTerm); }); if (filteredLoans.length === 0) { document.getElementById('loans-modal-content').innerHTML = `<p style="text-align: center; padding: 1rem;">لا توجد نتائج مطابقة.</p>`; return; } const currentLang = document.documentElement.lang; const headers = { ar: ["اسم الطالب", "عنوان الكتاب", "تاريخ الإعارة", "تاريخ التسليم", "إجراء"], fr: ["Nom", "Titre", "Date d'emprunt", "Date de retour", "Action"], en: ["Name", "Title", "Loan Date", "Return Date", "Action"] }; const returnText = { ar: "إرجاع", fr: "Retourner", en: "Return" }; let tableHTML = `<table id="loans-table"><thead><tr><th>${headers[currentLang][0]}</th><th>${headers[currentLang][1]}</th><th>${headers[currentLang][2]}</th><th>${headers[currentLang][3]}</th><th>${headers[currentLang][4]}</th></tr></thead><tbody>`; filteredLoans.forEach(loan => { const book = allBooks.find(b => b.isbn === loan.isbn); tableHTML += `<tr><td>${loan.studentName}</td><td>${book ? book.title : 'Livre inconnu'}</td><td>${new Date(loan.loanDate).toLocaleDateString()}</td><td>${new Date(loan.returnDate).toLocaleDateString()}</td><td><button class="btn-action btn-return" data-isbn="${loan.isbn}" data-student="${loan.studentName}"><i class="fas fa-undo"></i> ${returnText[currentLang]}</button></td></tr>`; }); tableHTML += `</tbody></table>`; document.getElementById('loans-modal-content').innerHTML = tableHTML; document.querySelectorAll('.btn-return').forEach(button => { button.addEventListener('click', (e) => { const isbn = e.currentTarget.dataset.isbn; const studentName = e.currentTarget.dataset.student; returnLoan(isbn, studentName); }); });
        };
        
        // --- GESTION DES MODALES ---
        const openModal = (modalElement) => { modalOverlay.style.display = 'flex'; modalElement.style.display = 'flex'; };
        const closeModal = () => { modalOverlay.style.display = 'none'; editModal.style.display = 'none'; loansModal.style.display = 'none'; historyModal.style.display = 'none'; };
        modalOverlay.addEventListener('click', (e) => { if (e.target === modalOverlay) closeModal(); });
        document.querySelectorAll('.close-modal-btn').forEach(btn => btn.addEventListener('click', closeModal));

        const openEditModal = (isbn) => {
            const book = allBooks.find(b => b.isbn === isbn);
            if (!book) return;
            // ... (remplissage du formulaire identique)
            document.getElementById('edit-original-isbn').value = book.isbn; document.getElementById('edit-title').value = book.title; document.getElementById('edit-isbn').value = book.isbn; document.getElementById('edit-quantity').value = book.totalCopies; document.getElementById('edit-subject').value = book.subject || ''; document.getElementById('edit-level').value = book.level || ''; document.getElementById('edit-language').value = book.language || ''; document.getElementById('edit-corner-name').value = book.cornerName || ''; document.getElementById('edit-corner-number').value = book.cornerNumber || '';
            openModal(editModal);
        };
        
        // --- ACTIONS CRUD ---
        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            if (document.getElementById('username').value === 'Alkawthar@30' && document.getElementById('password').value === 'Alkawthar@30') {
                loginPage.style.display = 'none';
                dashboardPage.style.display = 'block';
                fetchAllData(); // Charger les données depuis l'API
            } else {
                loginError.textContent = 'اسم المستخدم أو كلمة المرور غير صحيحة.';
            }
        });
        logoutBtn.addEventListener('click', () => window.location.reload());

        addBookForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const bookData = {
                title: document.getElementById('new-title').value,
                isbn: document.getElementById('new-isbn').value.trim(),
                totalCopies: parseInt(document.getElementById('new-quantity').value, 10),
                subject: document.getElementById('new-subject').value,
                level: document.getElementById('new-level').value,
                language: document.getElementById('new-language').value,
                cornerName: document.getElementById('new-corner-name').value,
                cornerNumber: document.getElementById('new-corner-number').value,
            };
            await apiFetch('/books', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(bookData)
            });
            addBookForm.reset();
            await fetchAllData();
        });
        
        uploadExcelBtn.addEventListener('click', async () => {
            const fileInput = document.getElementById('excel-file-input');
            if (fileInput.files.length === 0) {
                document.getElementById('upload-status').textContent = 'الرجاء اختيار ملف.';
                return;
            }
            const formData = new FormData();
            formData.append('excelFile', fileInput.files[0]);
            
            document.getElementById('upload-status').textContent = 'جاري معالجة الملف...';
            try {
                const result = await apiFetch('/books/upload', { method: 'POST', body: formData });
                document.getElementById('upload-status').textContent = `✅ ${result.message} Ajoutés: ${result.addedCount}, Mis à jour: ${result.updatedCount}.`;
                fileInput.value = '';
                await fetchAllData();
            } catch (error) {
                 document.getElementById('upload-status').textContent = "❌ خطأ في معالجة الملف.";
            }
        });

        const deleteBook = async (isbn, title) => {
            if (confirm(`Êtes-vous sûr de vouloir supprimer "${title}"?`)) {
                await apiFetch(`/books/${isbn}`, { method: 'DELETE' });
                await fetchAllData();
            }
        };

        editBookForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const originalIsbn = document.getElementById('edit-original-isbn').value;
            const bookToUpdate = allBooks.find(b => b.isbn === originalIsbn);
            const newTotalCopies = parseInt(document.getElementById('edit-quantity').value, 10);
            if (newTotalCopies < bookToUpdate.loanedCopies) {
                alert('La quantité totale ne peut pas être inférieure au nombre de livres déjà prêtés.');
                return;
            }
            
            const updatedData = { /* ... récupérer les valeurs du form ... */
                 title : document.getElementById('edit-title').value, isbn : document.getElementById('edit-isbn').value.trim(), totalCopies : newTotalCopies, subject : document.getElementById('edit-subject').value, level : document.getElementById('edit-level').value, language : document.getElementById('edit-language').value, cornerName : document.getElementById('edit-corner-name').value, cornerNumber : document.getElementById('edit-corner-number').value
            };

            await apiFetch(`/books/${originalIsbn}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(updatedData)
            });
            closeModal();
            await fetchAllData();
        });

        loanForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const loanData = {
                isbn: document.getElementById('loan-isbn').value.trim(),
                studentName: document.getElementById('student-name').value,
                loanDate: document.getElementById('loan-date').value,
                returnDate: document.getElementById('return-date').value
            };
            await apiFetch('/loans', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(loanData)
            });
            loanForm.reset();
            document.getElementById('loan-book-title').textContent = '-';
            alert('Livre prêté avec succès!');
            await fetchAllData();
        });

        const returnLoan = async (isbn, studentName) => {
            await apiFetch('/loans', {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ isbn, studentName })
            });
            if (loansModal.style.display === 'flex') {
                // Mettre à jour la liste des prêts affichés sans tout recharger
                allLoans = allLoans.filter(l => !(l.isbn === isbn && l.studentName === studentName));
                displayLoans(document.getElementById('loan-search-input').value);
            }
            const book = allBooks.find(b => b.isbn === isbn);
            if (book) book.loanedCopies--;
            initializeDashboard();
        };

        // --- NOUVEAU: Fonctions d'historique ---
        const showBookHistory = async (isbn, title) => {
            historyModalTitle.textContent = `Historique du livre : ${title}`;
            const historyData = await apiFetch(`/history/book/${isbn}`);
            let content = `<p>Aucun historique trouvé.</p>`;
            if (historyData.length > 0) {
                content = `<table id="history-table">
                    <thead><tr><th>Nom de l'élève</th><th>Date de prêt</th><th>Date de retour</th></tr></thead>
                    <tbody>`;
                historyData.forEach(entry => {
                    content += `<tr>
                        <td>${entry.studentName}</td>
                        <td>${new Date(entry.loanDate).toLocaleDateString()}</td>
                        <td>${new Date(entry.actualReturnDate).toLocaleDateString()}</td>
                    </tr>`;
                });
                content += `</tbody></table>`;
            }
            historyModalContent.innerHTML = content;
            openModal(historyModal);
        };
        
        const showStudentHistory = async (studentName) => {
            historyModalTitle.textContent = `Historique de l'élève : ${studentName}`;
            const historyData = await apiFetch(`/history/student/${encodeURIComponent(studentName)}`);
             let content = `<p>Aucun historique trouvé.</p>`;
            if (historyData.length > 0) {
                content = `<table id="history-table">
                    <thead><tr><th>Titre du livre</th><th>ISBN</th><th>Date de prêt</th><th>Date de retour</th></tr></thead>
                    <tbody>`;
                historyData.forEach(entry => {
                    content += `<tr>
                        <td>${entry.bookTitle}</td>
                        <td>${entry.isbn}</td>
                        <td>${new Date(entry.loanDate).toLocaleDateString()}</td>
                        <td>${new Date(entry.actualReturnDate).toLocaleDateString()}</td>
                    </tr>`;
                });
                content += `</tbody></table>`;
            }
            historyModalContent.innerHTML = content;
            openModal(historyModal);
        };
        
        studentHistoryForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const studentName = document.getElementById('student-history-search').value.trim();
            if(studentName) {
                showStudentHistory(studentName);
            }
        });
        
        // --- Écouteurs d'événements divers ---
        viewLoansBtn.addEventListener('click', () => { displayLoans(); openModal(loansModal); document.getElementById('loan-search-input').focus(); });
        searchInput.addEventListener('input', (e) => { const searchTerm = e.target.value.toLowerCase(); renderTable(allBooks.filter(b => b.title.toLowerCase().includes(searchTerm) || b.isbn.includes(searchTerm))); });
        document.getElementById('loan-search-input').addEventListener('input', (e) => displayLoans(e.target.value));
        document.getElementById('loan-isbn').addEventListener('input', (e) => { const book = allBooks.find(b => b.isbn === e.target.value.trim()); document.getElementById('loan-book-title').textContent = book ? book.title : '-'; });


        // --- GESTION DE LA LANGUE (INCHANGÉE) ---
        const translations = { ar: { title: "مكتبة الكوثر", student_history_title:"تاريخ الطالب", search_btn:"بحث", student_history_placeholder:"أدخل اسم الطالب للبحث", welcome_title: "مرحباً بكم في مكتبة مدارس الكوثر العالمية", welcome_subtitle: "الرجاء إدخال بيانات الاعتماد الخاصة بك للوصول إلى لوحة التحكم.", username_label: "اسم المستخدم", password_label: "كلمة المرور", login_btn: "تسجيل الدخول", dashboard_title: "لوحة تحكم مكتبة الكوثر", school_name: "مدارس الكوثر العالمية", logout_btn_title: "تسجيل الخروج", stats_title: "إحصائيات المكتبة", total_books: "إجمالي الكتب", loaned_books: "الكتب المعارة", available_books: "الكتب المتاحة", scanner_title: "بحث سريع بالباركود", scanner_label: "امсح ISBN الكتاب هنا:", scanner_placeholder: "امсح الباركود...", scanner_instruction: "الرجاء مسح كتاب ضوئياً لعرض معلوماته.", excel_upload_title: "إضافة عبر ملف Excel", excel_instruction: "اختر ملف (.xlsx) بالأعمدة: Title, ISBN, QTY, Subject, level, language, Corner name, Corner number", choose_file_btn: "اختر ملف...", upload_btn: "رفع الملف", search_book_title: "البحث في المخزون", search_placeholder: "ابحث بالعنوان أو ISBN...", isbn_col: "ISBN", title_col: "العنوان", corner_name_col: "اسم الركن", corner_num_col: "رقم الركن", availability_col: "الإتاحة", actions_col: "الإجراءات", add_book_title: "تسجيل كتاب جديد يدوياً", book_title_label: "عنوان الكتاب", save_book_btn: "حفظ الكتاب", manage_loan_title: "إدارة الإعارة", student_name_label: "اسم الطالب", loan_book_btn: "إعارة الكتاب", corner_name_label: "اسم الركن", corner_num_label: "رقم الركن", quantity_label: "الكمية", subject_label: "المادة", level_label: "المستوى", language_label: "اللغة", loan_date_label: "تاريخ الإعارة", return_date_label: "تاريخ التسليم", footer_text: "© 2025 مدارس الكوثر العالمية - جميع الحقوق محفوظة.", view_loans_btn: "عرض الطلاب المستعيرين", loaned_books_list_title: "قائمة الكتب المعارة", edit_book_title: "تعديل معلومات الكتاب", save_changes_btn: "حفظ التغييرات", loan_search_placeholder: "ابحث بالاسم، العنوان، أو امсح ISBN...", return_action: "إرجاع" }, fr: { /* ... */ }, en: { /* ... */ } };
        const switchLanguage = (lang) => { document.documentElement.lang = lang; document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr'; document.querySelectorAll('[data-lang-key]').forEach(el => { const key = el.getAttribute('data-lang-key'); if (translations[lang] && translations[lang][key]) { el.textContent = translations[lang][key]; } }); document.querySelectorAll('[data-lang-key-placeholder]').forEach(el => { const key = el.getAttribute('data-lang-key-placeholder'); if (translations[lang] && translations[lang][key]) { el.placeholder = translations[lang][key]; } }); if (dashboardPage.style.display === 'block') { renderTable(allBooks); } };
        document.querySelectorAll('.lang-btn').forEach(btn => btn.addEventListener('click', (e) => switchLanguage(e.target.getAttribute('data-lang'))));
        switchLanguage('ar');
    });
    </script>
</body>
</html>
