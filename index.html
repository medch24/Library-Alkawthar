<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مكتبة الكوثر</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
    <!-- Page de connexion -->
    <div id="login-page" style="display: flex;">
        <div class="login-container">
            <img src="https://lh3.googleusercontent.com/d/1lQ3Babrs3Wgv4rakVmkK0oCWcM0cTKPK" alt="Logo Alkawthar" class="logo">
            <h1>مرحباً بكم في مكتبة مدارس الكوثر العالمية</h1>
            <p class="welcome-subtitle">الرجاء إدخال بيانات الاعتماد الخاصة بك للوصول إلى لوحة التحكم.</p>
            <form id="login-form">
                <div class="input-group">
                    <i class="fas fa-user"></i>
                    <input type="text" id="username" placeholder="اسم المستخدم" required>
                </div>
                <div class="input-group">
                    <i class="fas fa-lock"></i>
                    <input type="password" id="password" placeholder="كلمة المرور" required>
                </div>
                <button type="submit" class="btn">تسجيل الدخول</button>
                <p id="login-error" class="error-message"></p>
            </form>
        </div>
    </div>

    <!-- Tableau de bord -->
    <div id="dashboard-page" style="display:none;">
        <header>
            <div class="logo-header">
                <i class="fas fa-book-open"></i>
                <h1>لوحة تحكم مكتبة الكوثر</h1>
            </div>
            <div class="header-controls">
                <!-- Sélecteur de langue -->
                <div class="language-selector">
                    <button class="lang-btn active" data-lang="ar" title="العربية">
                        <i class="fas fa-globe"></i> عربي
                    </button>
                    <button class="lang-btn" data-lang="fr" title="Français">
                        <i class="fas fa-globe"></i> FR
                    </button>
                    <button class="lang-btn" data-lang="en" title="English">
                        <i class="fas fa-globe"></i> EN
                    </button>
                </div>
                <div class="header-user">
                    <span data-key="school_name">مدارس الكوثر العالمية</span>
                    <i class="fas fa-school"></i>
                </div>
                <button id="logout-btn" class="btn-logout">
                    <i class="fas fa-sign-out-alt"></i>
                    <span data-key="logout">تسجيل الخروج</span>
                </button>
            </div>
        </header>

        <!-- Barre de progression pour le chargement -->
        <div id="loading-bar" class="loading-bar" style="display: none;">
            <div class="loading-progress">
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
                <div class="loading-text">
                    <i class="fas fa-spinner fa-spin"></i>
                    <span id="loading-text-span" data-key="loading_data">تحميل البيانات...</span>
                </div>
            </div>
        </div>

        <main class="container">
            <section class="card stats-card animated">
                <h2><i class="fas fa-chart-pie"></i> <span data-key="library_stats">إحصائيات المكتبة</span></h2>
                <div class="stats-container">
                    <div class="stat-item">
                        <i class="fas fa-book"></i>
                        <div>
                            <span id="total-books-stat">0</span>
                            <p data-key="total_books">إجمالي الكتب</p>
                        </div>
                    </div>
                    <div class="stat-item">
                        <i class="fas fa-hand-holding-heart"></i>
                        <div>
                            <span id="loaned-books-stat">0</span>
                            <p data-key="loaned_books">الكتب المعارة</p>
                        </div>
                    </div>
                    <div class="stat-item">
                        <i class="fas fa-check-circle"></i>
                        <div>
                            <span id="available-books-stat">0</span>
                            <p data-key="available_books">الكتب المتاحة</p>
                        </div>
                    </div>
                </div>
                <div style="margin-top: 1rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
                    <button id="view-student-loans-btn" class="btn btn-secondary">
                        <i class="fas fa-user-graduate"></i> 
                        <span>عرض الطلاب المستعيرين</span>
                    </button>
                    <button id="view-teacher-loans-btn" class="btn btn-secondary">
                        <i class="fas fa-user-tie"></i> 
                        <span>عرض المدرسين المستعيرين</span>
                    </button>
                    <button id="export-excel-btn" class="btn btn-success">
                        <i class="fas fa-file-excel"></i> 
                        <span>تحميل بيانات Excel</span>
                    </button>
                </div>
            </section>

            <div class="columns">
                <section class="card animated">
                    <h2><i class="fas fa-plus-circle"></i> <span data-key="loan_management">إدارة الإعارة</span></h2>
                    <form id="loan-form">
                        <div class="form-group">
                            <label for="loan-isbn">ISBN الكتاب</label>
                            <input type="text" id="loan-isbn" required>
                        </div>
                        <div class="form-group auto-filled">
                            <label>عنوان الكتاب</label>
                            <p id="loan-book-title">-</p>
                        </div>
                        <div class="form-group">
                            <label for="borrower-type">نوع المستعير</label>
                            <select id="borrower-type" required>
                                <option value="student">طالب</option>
                                <option value="teacher">مدرس/ة</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="student-name">اسم المستعير</label>
                            <input type="text" id="student-name" required>
                        </div>
                        <div class="form-group">
                            <label for="student-class">الفصل/المادة</label>
                            <input type="text" id="student-class" required>
                        </div>
                        <div class="form-group">
                            <label for="loan-date">تاريخ الإعارة</label>
                            <input type="date" id="loan-date" required>
                        </div>
                        <div class="form-group">
                            <label for="return-date">تاريخ التسليم</label>
                            <input type="date" id="return-date" required>
                        </div>
                        <button type="submit" class="btn">إعارة الكتاب</button>
                    </form>
                </section>

                <section class="card animated">
                    <h2><i class="fas fa-book-medical"></i> <span data-key="add_book_manually">إضافة كتاب يدوياً</span></h2>
                    <form id="manual-book-form">
                        <div class="form-group">
                            <label for="manual-isbn">ISBN</label>
                            <input type="text" id="manual-isbn" required>
                        </div>
                        <div class="form-group">
                            <label for="manual-title">عنوان الكتاب</label>
                            <input type="text" id="manual-title" required>
                        </div>
                        <div class="form-group">
                            <label for="manual-copies">عدد النسخ</label>
                            <input type="number" id="manual-copies" min="1" value="1" required>
                        </div>
                        <div class="form-group">
                            <label for="manual-subject">المادة</label>
                            <input type="text" id="manual-subject" placeholder="اختياري">
                        </div>
                        <div class="form-group">
                            <label for="manual-level">المستوى</label>
                            <input type="text" id="manual-level" placeholder="اختياري">
                        </div>
                        <div class="form-group">
                            <label for="manual-language">اللغة</label>
                            <input type="text" id="manual-language" placeholder="اختياري">
                        </div>
                        <div class="form-group">
                            <label for="manual-corner-name">اسم الركن</label>
                            <input type="text" id="manual-corner-name" placeholder="اختياري">
                        </div>
                        <div class="form-group">
                            <label for="manual-corner-number">رقم الركن</label>
                            <input type="text" id="manual-corner-number" placeholder="اختياري">
                        </div>
                        <button type="submit" class="btn btn-primary">إضافة الكتاب</button>
                    </form>
                </section>

                <section class="card animated">
                    <h2><i class="fas fa-file-upload"></i> <span data-key="upload_excel">رفع ملف Excel للكتب</span></h2>
                    <div class="form-group">
                        <label for="excel-file">اختر ملف Excel</label>
                        <input type="file" id="excel-file" accept=".xlsx,.xls" required>
                    </div>
                    <button id="upload-excel-btn" class="btn btn-success">رفع الملف</button>
                    <div id="upload-status" style="margin-top: 10px;"></div>
                </section>

            </div>

            <!-- Section du tableau sur toute la largeur -->
            <section class="card animated full-width-section">
                <h2><i class="fas fa-search"></i> <span data-key="inventory_search">البحث في المخزون وإدارة الكتب</span></h2>
                <div class="form-group">
                    <input type="text" id="search-input" placeholder="ابحث بالعنوان أو ISBN أو المادة..." data-key-placeholder="search_placeholder">
                    <button id="refresh-books-btn" class="btn btn-secondary" style="margin-left: 10px;">
                        <i class="fas fa-sync-alt"></i> <span data-key="refresh">تحديث</span>
                    </button>
                </div>
                <div class="table-container" style="overflow-x: auto; max-width: 100%;">
                    <table id="books-table" style="width: 100%; min-width: 1400px;">
                        <thead>
                            <tr>
                                <th style="min-width: 140px;" data-key="isbn">ISBN</th>
                                <th style="min-width: 250px;" data-key="title">العنوان</th>
                                <th style="min-width: 120px;" data-key="total_copies">إجمالي النسخ</th>
                                <th style="min-width: 120px;" data-key="loaned_copies">النسخ المعارة</th>
                                <th style="min-width: 120px;" data-key="available_copies">النسخ المتاحة</th>
                                <th style="min-width: 140px;" data-key="subject">المادة</th>
                                <th style="min-width: 100px;" data-key="level">المستوى</th>
                                <th style="min-width: 100px;" data-key="language">اللغة</th>
                                <th style="min-width: 140px;" data-key="corner_name">اسم الركن</th>
                                <th style="min-width: 120px;" data-key="corner_number">رقم الركن</th>
                                <th style="min-width: 180px;" data-key="actions">الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="books-table-body"></tbody>
                    </table>
                </div>
            </section>
        </main>

        <footer>
            <p>&copy; 2025 مدارس الكوثر العالمية - جميع الحقوق محفوظة.</p>
        </footer>
    </div>

    <!-- Modal pour les prêts -->
    <div id="modal-overlay" class="modal-overlay" style="display:none;">
        <div id="loans-modal" class="modal">
            <button class="close-modal-btn">&times;</button>
            <h2 id="loans-modal-title">قائمة الكتب المعارة</h2>
            <div class="form-group">
                <input type="text" id="loan-search-input" placeholder="ابحث بالاسم، العنوان، أو امسح ISBN...">
            </div>
            <div id="loans-modal-content" class="table-container"></div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'https://3002-iznkr1yjob21txfccaszw-c81df28e.sandbox.novita.ai';
        let allBooks = [];
        let allLoans = [];
        let currentLoanType = 'students';
        let currentLanguage = 'ar';

        // Dictionnaire des traductions
        const translations = {
            ar: {
                school_name: 'مدارس الكوثر العالمية',
                logout: 'تسجيل الخروج',
                library_stats: 'إحصائيات المكتبة',
                total_books: 'إجمالي الكتب',
                loaned_books: 'الكتب المعارة',
                available_books: 'الكتب المتاحة',
                inventory_search: 'البحث في المخزون وإدارة الكتب',
                search_placeholder: 'ابحث بالعنوان أو ISBN أو المادة...',
                refresh: 'تحديث',
                loading_data: 'تحميل البيانات...',
                isbn: 'ISBN',
                title: 'العنوان',
                total_copies: 'إجمالي النسخ',
                loaned_copies: 'النسخ المعارة',
                available_copies: 'النسخ المتاحة',
                subject: 'المادة',
                level: 'المستوى',
                language: 'اللغة',
                corner_name: 'اسم الركن',
                corner_number: 'رقم الركن',
                actions: 'الإجراءات',
                loading_books: 'جاري تحميل الكتب...',
                loading_loans: 'جاري تحميل الإعارات...',
                loading_stats: 'جاري حساب الإحصائيات...',
                data_loaded: 'تم تحميل البيانات بنجاح!',
                loan_management: 'إدارة الإعارة',
                add_book_manually: 'إضافة كتاب يدوياً',
                upload_excel: 'رفع ملف Excel للكتب'
            },
            fr: {
                school_name: 'Écoles Internationales Al-Kawthar',
                logout: 'Se déconnecter',
                library_stats: 'Statistiques de la bibliothèque',
                total_books: 'Total des livres',
                loaned_books: 'Livres prêtés',
                available_books: 'Livres disponibles',
                inventory_search: 'Recherche et gestion de l\'inventaire',
                search_placeholder: 'Rechercher par titre, ISBN ou matière...',
                refresh: 'Actualiser',
                loading_data: 'Chargement des données...',
                isbn: 'ISBN',
                title: 'Titre',
                total_copies: 'Copies totales',
                loaned_copies: 'Copies prêtées',
                available_copies: 'Copies disponibles',
                subject: 'Matière',
                level: 'Niveau',
                language: 'Langue',
                corner_name: 'Nom du coin',
                corner_number: 'Numéro du coin',
                actions: 'Actions',
                loading_books: 'Chargement des livres...',
                loading_loans: 'Chargement des prêts...',
                loading_stats: 'Calcul des statistiques...',
                data_loaded: 'Données chargées avec succès!',
                loan_management: 'Gestion des prêts',
                add_book_manually: 'Ajouter un livre manuellement',
                upload_excel: 'Télécharger fichier Excel'
            },
            en: {
                school_name: 'Al-Kawthar International Schools',
                logout: 'Logout',
                library_stats: 'Library Statistics',
                total_books: 'Total Books',
                loaned_books: 'Loaned Books',
                available_books: 'Available Books',
                inventory_search: 'Inventory Search & Management',
                search_placeholder: 'Search by title, ISBN or subject...',
                refresh: 'Refresh',
                loading_data: 'Loading data...',
                isbn: 'ISBN',
                title: 'Title',
                total_copies: 'Total Copies',
                loaned_copies: 'Loaned Copies',
                available_copies: 'Available Copies',
                subject: 'Subject',
                level: 'Level',
                language: 'Language',
                corner_name: 'Corner Name',
                corner_number: 'Corner Number',
                actions: 'Actions',
                loading_books: 'Loading books...',
                loading_loans: 'Loading loans...',
                loading_stats: 'Calculating statistics...',
                data_loaded: 'Data loaded successfully!',
                loan_management: 'Loan Management',
                add_book_manually: 'Add Book Manually',
                upload_excel: 'Upload Excel File'
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            const loginPage = document.getElementById('login-page');
            const dashboardPage = document.getElementById('dashboard-page');
            const loginForm = document.getElementById('login-form');
            const loanForm = document.getElementById('loan-form');
            const searchInput = document.getElementById('search-input');
            const modalOverlay = document.getElementById('modal-overlay');
            const loansModal = document.getElementById('loans-modal');

            // FONCTIONS DE TRADUCTION ET BARRE DE PROGRESSION
            
            // Fonction pour changer la langue
            function changeLanguage(lang) {
                currentLanguage = lang;
                localStorage.setItem('preferred_language', lang);
                
                // Changer la direction du document
                if (lang === 'ar') {
                    document.documentElement.setAttribute('dir', 'rtl');
                    document.documentElement.setAttribute('lang', 'ar');
                } else {
                    document.documentElement.setAttribute('dir', 'ltr');
                    document.documentElement.setAttribute('lang', lang);
                }
                
                // Mettre à jour tous les éléments traduits
                updateTranslations();
                
                // Mettre à jour les boutons de langue
                document.querySelectorAll('.lang-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.lang === lang);
                });
            }
            
            // Fonction pour mettre à jour les traductions
            function updateTranslations() {
                const currentTranslations = translations[currentLanguage];
                if (!currentTranslations) {
                    console.warn('No translations found for language:', currentLanguage);
                    return;
                }
                
                // Mettre à jour les éléments avec data-key
                document.querySelectorAll('[data-key]').forEach(element => {
                    if (!element) return;
                    const key = element.getAttribute('data-key');
                    if (key && currentTranslations[key]) {
                        try {
                            element.textContent = currentTranslations[key];
                        } catch (error) {
                            console.warn('Error updating text for element with key:', key, error);
                        }
                    }
                });
                
                // Mettre à jour les placeholders
                document.querySelectorAll('[data-key-placeholder]').forEach(element => {
                    if (!element) return;
                    const key = element.getAttribute('data-key-placeholder');
                    if (key && currentTranslations[key]) {
                        try {
                            element.placeholder = currentTranslations[key];
                        } catch (error) {
                            console.warn('Error updating placeholder for element with key:', key, error);
                        }
                    }
                });
            }
            
            // Gestionnaires d'événements pour les boutons de langue
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    changeLanguage(btn.dataset.lang);
                });
            });
            
            // Charger la langue préférée après la définition des gestionnaires
            const savedLang = localStorage.getItem('preferred_language') || 'ar';
            // Attendre un peu pour s'assurer que le DOM est prêt
            setTimeout(() => {
                changeLanguage(savedLang);
            }, 100);
            
            // FONCTIONS DE BARRE DE PROGRESSION
            
            let loadingSteps = [];
            let currentStep = 0;
            
            function showLoadingBar(steps) {
                loadingSteps = steps;
                currentStep = 0;
                const loadingBar = document.getElementById('loading-bar');
                const progressFill = document.getElementById('progress-fill');
                
                if (loadingBar) loadingBar.style.display = 'block';
                if (loadingBar) loadingBar.classList.add('show');
                if (progressFill) progressFill.style.width = '0%';
                
                if (steps && steps.length > 0) {
                    updateLoadingText(steps[0]);
                }
            }
            
            function updateProgress(stepIndex, stepText) {
                if (!loadingSteps || stepIndex >= loadingSteps.length) return;
                
                currentStep = stepIndex;
                const progressPercent = ((stepIndex + 1) / loadingSteps.length) * 100;
                const progressFill = document.getElementById('progress-fill');
                
                if (progressFill) {
                    progressFill.style.width = progressPercent + '%';
                }
                
                if (stepText) {
                    updateLoadingText(stepText);
                }
                
                // Si c'est la dernière étape, cacher la barre après un délai
                if (stepIndex === loadingSteps.length - 1) {
                    setTimeout(() => {
                        hideLoadingBar();
                    }, 1000);
                }
            }
            
            function updateLoadingText(text) {
                const loadingTextSpan = document.getElementById('loading-text-span');
                if (loadingTextSpan) {
                    // Utiliser la traduction si disponible
                    const currentTranslations = translations[currentLanguage];
                    const translatedText = currentTranslations[text] || text;
                    loadingTextSpan.textContent = translatedText;
                }
            }
            
            function hideLoadingBar() {
                const loadingBar = document.getElementById('loading-bar');
                if (!loadingBar) return;
                
                loadingBar.classList.remove('show');
                loadingBar.classList.add('hide');
                
                setTimeout(() => {
                    loadingBar.style.display = 'none';
                    loadingBar.classList.remove('hide');
                }, 500);
            }

            // Connexion
            loginForm.addEventListener('submit', (e) => {
                e.preventDefault();
                if (document.getElementById('username').value === 'Alkawthar@30' && 
                    document.getElementById('password').value === 'Alkawthar@30') {
                    localStorage.setItem('isLoggedIn', 'true');
                    showDashboard();
                } else {
                    document.getElementById('login-error').textContent = 'اسم المستخدم أو كلمة المرور غير صحيحة.';
                }
            });

            // Déconnexion
            document.getElementById('logout-btn').addEventListener('click', () => {
                localStorage.removeItem('isLoggedIn');
                window.location.reload();
            });

            // Afficher le tableau de bord
            function showDashboard() {
                loginPage.style.display = 'none';
                dashboardPage.style.display = 'block';
                loadAllData();
            }

            // Vérifier la session après définition de toutes les fonctions
            if (localStorage.getItem('isLoggedIn') === 'true') {
                showDashboard();
            }

            // Charger toutes les données avec barre de progression
            async function loadAllData() {
                try {
                    console.log('Démarrage du chargement des données...');
                    // Afficher la barre de progression
                    showLoadingBar(['loading_books', 'loading_loans', 'loading_stats', 'data_loaded']);
                    
                    // Étape 1: Charger les livres
                    updateProgress(0, 'loading_books');
                    console.log('Chargement des livres depuis:', API_BASE_URL + '/api/books');
                    const booksResponse = await fetch(API_BASE_URL + '/api/books');
                    if (!booksResponse.ok) {
                        throw new Error(`HTTP Error: ${booksResponse.status} - ${booksResponse.statusText}`);
                    }
                    const books = await booksResponse.json();
                    allBooks = Array.isArray(books) ? books : [];
                    console.log('Livres chargés:', allBooks.length);
                    
                    // Petit délai pour voir la progression
                    await new Promise(resolve => setTimeout(resolve, 300));
                    
                    // Étape 2: Charger les prêts
                    updateProgress(1, 'loading_loans');
                    console.log('Chargement des prêts depuis:', API_BASE_URL + '/api/loans');
                    const loansResponse = await fetch(API_BASE_URL + '/api/loans');
                    if (!loansResponse.ok) {
                        throw new Error(`HTTP Error: ${loansResponse.status} - ${loansResponse.statusText}`);
                    }
                    const loans = await loansResponse.json();
                    allLoans = Array.isArray(loans) ? loans : [];
                    console.log('Prêts chargés:', allLoans.length);
                    
                    await new Promise(resolve => setTimeout(resolve, 300));
                    
                    // Étape 3: Calculer les statistiques
                    updateProgress(2, 'loading_stats');
                    updateStats();
                    
                    await new Promise(resolve => setTimeout(resolve, 300));
                    
                    // Étape 4: Afficher les données
                    console.log('Rendu du tableau...');
                    renderTable(allBooks);
                    updateProgress(3, 'data_loaded');
                    
                    // Mettre à jour les traductions après le rendu
                    setTimeout(() => {
                        console.log('Mise à jour des traductions...');
                        updateTranslations();
                    }, 200);
                    
                    console.log('Données chargées avec succès:', allBooks.length, 'livres,', allLoans.length, 'prêts');
                } catch (error) {
                    console.error('Erreur lors du chargement des données:', error);
                    hideLoadingBar();
                    
                    // Message d'erreur plus informatif
                    let errorMessage = 'خطأ في تحميل البيانات';
                    if (error.message.includes('fetch')) {
                        errorMessage += ' - مشكلة في الاتصال بالخادم';
                    } else if (error.message.includes('HTTP Error')) {
                        errorMessage += ' - خطأ في الخادم: ' + error.message;
                    } else {
                        errorMessage += ': ' + error.message;
                    }
                    
                    alert(errorMessage);
                }
            }

            // Mettre à jour les statistiques
            function updateStats() {
                const totalCopies = allBooks.reduce((sum, book) => sum + (book.totalCopies || 0), 0);
                const loanedCopies = allBooks.reduce((sum, book) => sum + (book.loanedCopies || 0), 0);
                document.getElementById('total-books-stat').textContent = totalCopies;
                document.getElementById('loaned-books-stat').textContent = loanedCopies;
                document.getElementById('available-books-stat').textContent = totalCopies - loanedCopies;
            }

            // Afficher le tableau des livres - VERSION COMPLÈTE AVEC ÉDITION
            function renderTable(bookList) {
                const tableBody = document.getElementById('books-table-body');
                if (!tableBody) {
                    console.error('Element books-table-body not found');
                    return;
                }
                
                if (!Array.isArray(bookList)) {
                    console.warn('bookList is not an array:', bookList);
                    bookList = [];
                }
                
                let tableHTML = '';
                bookList.forEach((book, index) => {
                    if (!book || typeof book !== 'object') {
                        console.warn('Invalid book object at index', index, ':', book);
                        return;
                    }
                    
                    const totalCopies = parseInt(book.totalCopies) || 0;
                    const loanedCopies = parseInt(book.loanedCopies) || 0;
                    const availableCopies = totalCopies - loanedCopies;
                    const availabilityClass = availableCopies > 0 ? 'status-available' : 'status-unavailable';
                    const availabilityText = `${availableCopies}`;
                    
                    // Escape HTML content to prevent XSS
                    const escapeHtml = (text) => {
                        const div = document.createElement('div');
                        div.textContent = text || '';
                        return div.innerHTML;
                    };
                    
                    tableHTML += `<tr data-isbn="${escapeHtml(book.isbn)}">
                        <td class="editable-cell" data-field="isbn" title="Double-cliquez pour modifier">${escapeHtml(book.isbn || '')}</td>
                        <td class="editable-cell" data-field="title" title="Double-cliquez pour modifier">${escapeHtml(book.title || '')}</td>
                        <td class="editable-cell" data-field="totalCopies" title="Double-cliquez pour modifier">${totalCopies}</td>
                        <td style="background-color: #f0f0f0;">${loanedCopies}</td>
                        <td class="${availabilityClass}" style="font-weight: bold;">${availabilityText}</td>
                        <td class="editable-cell" data-field="subject" title="Double-cliquez pour modifier">${escapeHtml(book.subject || 'Non classé')}</td>
                        <td class="editable-cell" data-field="level" title="Double-cliquez pour modifier">${escapeHtml(book.level || 'undefined')}</td>
                        <td class="editable-cell" data-field="language" title="Double-cliquez pour modifier">${escapeHtml(book.language || 'Non spécifié')}</td>
                        <td class="editable-cell" data-field="cornerName" title="Double-cliquez pour modifier">${escapeHtml(book.cornerName || 'Non classé')}</td>
                        <td class="editable-cell" data-field="cornerNumber" title="Double-cliquez pour modifier">${escapeHtml(book.cornerNumber || '0')}</td>
                        <td class="action-buttons">
                            <button class="btn-small btn-primary edit-book-btn" data-isbn="${escapeHtml(book.isbn || '')}" title="Modifier le livre">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn-small btn-danger delete-book-btn" data-isbn="${escapeHtml(book.isbn || '')}" title="Supprimer le livre">
                                <i class="fas fa-trash"></i>
                            </button>
                            <button class="btn-small btn-info history-book-btn" data-isbn="${escapeHtml(book.isbn || '')}" title="Voir l'historique">
                                <i class="fas fa-history"></i>
                            </button>
                        </td>
                    </tr>`;
                });
                
                tableBody.innerHTML = tableHTML;
                console.log('Table rendered with', bookList.length, 'books');
                
                // Ajouter les gestionnaires d'événements pour l'édition
                try {
                    addTableEventListeners();
                } catch (error) {
                    console.error('Error adding table event listeners:', error);
                }
                
                // Mettre à jour les traductions après le rendu du tableau
                setTimeout(() => {
                    try {
                        updateTranslations();
                    } catch (error) {
                        console.error('Error updating translations after table render:', error);
                    }
                }, 100);
            }

            // Recherche
            searchInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                const filteredBooks = searchTerm ? 
                    allBooks.filter(book => 
                        book.title.toLowerCase().includes(searchTerm) || 
                        book.isbn.includes(searchTerm)
                    ) : allBooks;
                renderTable(filteredBooks);
            });

            // Mise à jour du titre du livre lors de la saisie ISBN
            document.getElementById('loan-isbn').addEventListener('input', (e) => {
                const book = allBooks.find(b => b.isbn === e.target.value.trim());
                document.getElementById('loan-book-title').textContent = book ? book.title : '-';
            });

            // Gestion des prêts
            loanForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const loanData = {
                    isbn: document.getElementById('loan-isbn').value.trim(),
                    studentName: document.getElementById('student-name').value,
                    studentClass: document.getElementById('student-class').value,
                    borrowerType: document.getElementById('borrower-type').value,
                    loanDate: document.getElementById('loan-date').value,
                    returnDate: document.getElementById('return-date').value
                };
                
                try {
                    await fetch(API_BASE_URL + '/api/loans', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(loanData)
                    });
                    loanForm.reset();
                    document.getElementById('loan-book-title').textContent = '-';
                    alert('تم إعارة الكتاب بنجاح!');
                    await loadAllData();
                } catch (error) {
                    alert('خطأ في إعارة الكتاب');
                }
            });

            // Voir les prêts étudiants
            document.getElementById('view-student-loans-btn').addEventListener('click', () => {
                currentLoanType = 'students';
                displayLoans('students');
                openModal(loansModal);
            });

            // Voir les prêts enseignants
            document.getElementById('view-teacher-loans-btn').addEventListener('click', () => {
                currentLoanType = 'teachers';
                displayLoans('teachers');
                openModal(loansModal);
            });

            // Export Excel
            document.getElementById('export-excel-btn').addEventListener('click', async () => {
                try {
                    const response = await fetch(API_BASE_URL + '/api/export/excel');
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    a.download = `library_data_${new Date().toISOString().split('T')[0]}.xlsx`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    alert('تم تحميل ملف Excel بنجاح!');
                } catch (error) {
                    alert('خطأ في تحميل ملف Excel');
                }
            });

            // Manual book addition
            document.getElementById('manual-book-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const bookData = {
                    isbn: document.getElementById('manual-isbn').value,
                    title: document.getElementById('manual-title').value,
                    totalCopies: parseInt(document.getElementById('manual-copies').value),
                    subject: document.getElementById('manual-subject').value || 'Non classé',
                    level: document.getElementById('manual-level').value || 'undefined',
                    language: document.getElementById('manual-language').value || 'Non spécifié',
                    cornerName: document.getElementById('manual-corner-name').value || 'Non classé',
                    cornerNumber: document.getElementById('manual-corner-number').value || '0',
                    loanedCopies: 0
                };
                
                try {
                    const response = await fetch(API_BASE_URL + '/api/books', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(bookData)
                    });
                    
                    if (response.ok) {
                        document.getElementById('manual-book-form').reset();
                        alert('تم إضافة الكتاب بنجاح!');
                        await loadAllData();
                    } else {
                        const error = await response.json();
                        alert('خطأ في إضافة الكتاب: ' + (error.message || 'خطأ غير معروف'));
                    }
                } catch (error) {
                    alert('خطأ في إضافة الكتاب: ' + error.message);
                }
            });

            // Excel file upload
            document.getElementById('upload-excel-btn').addEventListener('click', async () => {
                const fileInput = document.getElementById('excel-file');
                const statusDiv = document.getElementById('upload-status');
                
                if (!fileInput.files[0]) {
                    alert('يرجى اختيار ملف Excel أولاً');
                    return;
                }
                
                const formData = new FormData();
                formData.append('excelFile', fileInput.files[0]);
                
                try {
                    statusDiv.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري رفع الملف...';
                    
                    const response = await fetch(API_BASE_URL + '/api/books/upload', {
                        method: 'POST',
                        body: formData
                    });
                    
                    const result = await response.json();
                    
                    if (response.ok) {
                        statusDiv.innerHTML = `<i class="fas fa-check-circle" style="color: green;"></i> تم رفع الملف بنجاح! تمت إضافة ${result.addedCount} كتاب`;
                        fileInput.value = '';
                        await loadAllData();
                    } else {
                        statusDiv.innerHTML = `<i class="fas fa-exclamation-circle" style="color: red;"></i> خطأ: ${result.message}`;
                    }
                } catch (error) {
                    statusDiv.innerHTML = `<i class="fas fa-exclamation-circle" style="color: red;"></i> خطأ في رفع الملف: ${error.message}`;
                }
            });

            // Afficher les prêts
            async function displayLoans(loanType) {
                const loansModalContent = document.getElementById('loans-modal-content');
                const loansModalTitle = document.getElementById('loans-modal-title');
                
                try {
                    let loans = [];
                    if (loanType === 'students') {
                        loans = await fetch(API_BASE_URL + '/api/loans/students').then(r => r.json());
                        loansModalTitle.textContent = 'قائمة الطلاب المستعيرين';
                    } else {
                        loans = await fetch(API_BASE_URL + '/api/loans/teachers').then(r => r.json());
                        loansModalTitle.textContent = 'قائمة المدرسين المستعيرين';
                    }
                    
                    if (loans.length === 0) {
                        loansModalContent.innerHTML = '<p style="text-align: center; padding: 1rem;">لا توجد نتائج مطابقة.</p>';
                        return;
                    }
                    
                    const nameLabel = loanType === 'teachers' ? 'اسم المدرس' : 'اسم الطالب';
                    const classLabel = loanType === 'teachers' ? 'المادة' : 'الفصل';
                    
                    let tableHTML = `<table id="loans-table">
                        <thead>
                            <tr>
                                <th>${nameLabel}</th>
                                <th>${classLabel}</th>
                                <th>عنوان الكتاب</th>
                                <th>تاريخ الإعارة</th>
                                <th>تاريخ التسليم</th>
                                <th>إجراء</th>
                            </tr>
                        </thead>
                        <tbody>`;
                    
                    loans.forEach(loan => {
                        const book = allBooks.find(b => b.isbn === loan.isbn) || { title: 'عنوان غير محدد' };
                        tableHTML += `<tr>
                            <td>${loan.studentName}</td>
                            <td>${loan.studentClass || '-'}</td>
                            <td>${book.title}</td>
                            <td>${new Date(loan.loanDate).toLocaleDateString()}</td>
                            <td>${new Date(loan.returnDate).toLocaleDateString()}</td>
                            <td>
                                <button class="btn-action btn-return" data-isbn="${loan.isbn}" data-student="${loan.studentName}">
                                    <i class="fas fa-undo"></i> إرجاع
                                </button>
                            </td>
                        </tr>`;
                    });
                    
                    tableHTML += '</tbody></table>';
                    loansModalContent.innerHTML = tableHTML;
                    
                    // Gestion des retours
                    document.querySelectorAll('.btn-return').forEach(button => {
                        button.addEventListener('click', async (e) => {
                            const isbn = e.currentTarget.dataset.isbn;
                            const studentName = e.currentTarget.dataset.student;
                            await returnLoan(isbn, studentName);
                            displayLoans(currentLoanType);
                        });
                    });
                } catch (error) {
                    loansModalContent.innerHTML = '<p style="text-align: center; padding: 1rem; color: red;">خطأ في تحميل البيانات.</p>';
                }
            }

            // Retourner un livre
            async function returnLoan(isbn, studentName) {
                try {
                    await fetch(API_BASE_URL + '/api/loans', {
                        method: 'DELETE',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ isbn, studentName })
                    });
                    await loadAllData();
                    alert('تم إرجاع الكتاب بنجاح!');
                } catch (error) {
                    alert('خطأ في إرجاع الكتاب');
                }
            }

            // Gestion des modales
            function openModal(modalElement) {
                modalOverlay.style.display = 'flex';
                modalElement.style.display = 'flex';
            }

            function closeModal() {
                modalOverlay.style.display = 'none';
                loansModal.style.display = 'none';
            }

            modalOverlay.addEventListener('click', (e) => {
                if (e.target === modalOverlay) closeModal();
            });

            document.querySelectorAll('.close-modal-btn').forEach(btn => 
                btn.addEventListener('click', closeModal)
            );

            // NOUVELLES FONCTIONS POUR L'ÉDITION ET LA SUPPRESSION

            // Bouton de rafraîchissement des livres
            document.getElementById('refresh-books-btn').addEventListener('click', async () => {
                await loadAllData();
                alert('تم تحديث البيانات بنجاح!');
            });

            // Ajouter les gestionnaires d'événements pour le tableau
            function addTableEventListeners() {
                // Édition en double-cliquant sur une cellule
                document.querySelectorAll('.editable-cell').forEach(cell => {
                    cell.addEventListener('dblclick', function() {
                        editCell(this);
                    });
                });

                // Boutons de modification
                document.querySelectorAll('.edit-book-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const isbn = this.dataset.isbn;
                        editBookInModal(isbn);
                    });
                });

                // Boutons de suppression
                document.querySelectorAll('.delete-book-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const isbn = this.dataset.isbn;
                        deleteBook(isbn);
                    });
                });

                // Boutons d'historique
                document.querySelectorAll('.history-book-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const isbn = this.dataset.isbn;
                        showBookHistory(isbn);
                    });
                });
            }

            // Fonction pour éditer une cellule
            function editCell(cell) {
                if (cell.classList.contains('editing')) return;
                
                const originalValue = cell.textContent.trim();
                const field = cell.dataset.field;
                const isbn = cell.parentElement.dataset.isbn;
                
                cell.classList.add('editing');
                cell.innerHTML = `<input type="text" value="${originalValue}" data-original="${originalValue}">`;
                
                const input = cell.querySelector('input');
                input.focus();
                input.select();
                
                // Sauvegarder en appuyant sur Entrée
                input.addEventListener('keydown', async function(e) {
                    if (e.key === 'Enter') {
                        await saveCell(cell, field, isbn, this.value);
                    } else if (e.key === 'Escape') {
                        cancelEdit(cell, originalValue);
                    }
                });
                
                // Sauvegarder en perdant le focus
                input.addEventListener('blur', async function() {
                    await saveCell(cell, field, isbn, this.value);
                });
            }

            // Sauvegarder les modifications d'une cellule
            async function saveCell(cell, field, isbn, newValue) {
                const originalValue = cell.querySelector('input').dataset.original;
                
                if (newValue === originalValue) {
                    cancelEdit(cell, originalValue);
                    return;
                }
                
                try {
                    const updateData = {};
                    updateData[field] = field === 'totalCopies' ? parseInt(newValue) || 1 : newValue;
                    
                    const response = await fetch(`${API_BASE_URL}/api/books/${isbn}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(updateData)
                    });
                    
                    if (response.ok) {
                        cell.classList.remove('editing');
                        cell.textContent = newValue;
                        await loadAllData(); // Recharger pour mettre à jour les statistiques
                        
                        // Animation de succès
                        cell.style.backgroundColor = '#d4edda';
                        setTimeout(() => {
                            cell.style.backgroundColor = '';
                        }, 1000);
                    } else {
                        throw new Error('Erreur de sauvegarde');
                    }
                } catch (error) {
                    alert('خطأ في حفظ التعديلات: ' + error.message);
                    cancelEdit(cell, originalValue);
                }
            }

            // Annuler l'édition
            function cancelEdit(cell, originalValue) {
                cell.classList.remove('editing');
                cell.textContent = originalValue;
            }

            // Supprimer un livre
            async function deleteBook(isbn) {
                const book = allBooks.find(b => b.isbn === isbn);
                if (!book) return;
                
                const confirmMessage = `هل أنت متأكد من حذف الكتاب؟\n\nISBN: ${isbn}\nالعنوان: ${book.title}\n\nلا يمكن التراجع عن هذا الإجراء!`;
                
                if (!confirm(confirmMessage)) return;
                
                // Vérifier s'il y a des prêts actifs
                if (book.loanedCopies > 0) {
                    alert(`لا يمكن حذف هذا الكتاب!\n\nيوجد ${book.loanedCopies} نسخة معارة حالياً.\nيجب إرجاع جميع النسخ أولاً.`);
                    return;
                }
                
                try {
                    const response = await fetch(`${API_BASE_URL}/api/books/${isbn}`, {
                        method: 'DELETE'
                    });
                    
                    if (response.ok) {
                        alert('تم حذف الكتاب بنجاح!');
                        await loadAllData();
                    } else {
                        throw new Error('فشل في حذف الكتاب');
                    }
                } catch (error) {
                    alert('خطأ في حذف الكتاب: ' + error.message);
                }
            }

            // Afficher l'historique d'un livre
            async function showBookHistory(isbn) {
                try {
                    const response = await fetch(`${API_BASE_URL}/api/history/book/${isbn}`);
                    const history = await response.json();
                    
                    const book = allBooks.find(b => b.isbn === isbn);
                    const bookTitle = book ? book.title : 'كتاب غير معروف';
                    
                    let historyHTML = `<h3>تاريخ الكتاب: ${bookTitle}</h3>`;
                    historyHTML += `<p><strong>ISBN:</strong> ${isbn}</p>`;
                    
                    if (history.length === 0) {
                        historyHTML += '<p>لا يوجد تاريخ إعارة لهذا الكتاب.</p>';
                    } else {
                        historyHTML += '<div style="max-height: 400px; overflow-y: auto;"><table style="width: 100%; border-collapse: collapse;">';
                        historyHTML += '<thead><tr style="background: #f0f0f0;"><th style="padding: 8px; border: 1px solid #ddd;">اسم المستعير</th><th style="padding: 8px; border: 1px solid #ddd;">الصف/القسم</th><th style="padding: 8px; border: 1px solid #ddd;">النوع</th><th style="padding: 8px; border: 1px solid #ddd;">تاريخ الإعارة</th><th style="padding: 8px; border: 1px solid #ddd;">تاريخ الإرجاع</th></tr></thead><tbody>';
                        
                        history.forEach(h => {
                            historyHTML += `<tr>
                                <td style="padding: 8px; border: 1px solid #ddd;">${h.studentName}</td>
                                <td style="padding: 8px; border: 1px solid #ddd;">${h.studentClass || '-'}</td>
                                <td style="padding: 8px; border: 1px solid #ddd;">${h.borrowerType === 'teacher' ? 'مدرس' : 'طالب'}</td>
                                <td style="padding: 8px; border: 1px solid #ddd;">${new Date(h.loanDate).toLocaleDateString('ar-EG')}</td>
                                <td style="padding: 8px; border: 1px solid #ddd;">${new Date(h.actualReturnDate).toLocaleDateString('ar-EG')}</td>
                            </tr>`;
                        });
                        
                        historyHTML += '</tbody></table></div>';
                    }
                    
                    document.getElementById('loans-modal-content').innerHTML = historyHTML;
                    openModal(loansModal);
                } catch (error) {
                    alert('خطأ في تحميل تاريخ الكتاب: ' + error.message);
                }
            }
        });
    </script>
</body>
</html>