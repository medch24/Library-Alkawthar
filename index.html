<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-lang-key="title">مكتبة الكوثر</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
    <!-- Écran de chargement -->
    <div id="loading-overlay" style="display: none;">
        <div class="loading-text" data-lang-key="loading_data">جاري تحميل البيانات...</div>
        <div class="loading-progress-bar-container">
            <div class="loading-progress-bar"></div>
        </div>
    </div>

    <!-- Page de connexion -->
    <div id="login-page" style="display: none;">
         <div class="language-switcher standalone"><button class="lang-btn" data-lang="ar">العربية</button><button class="lang-btn" data-lang="fr">Français</button><button class="lang-btn" data-lang="en">English</button></div>
        <div class="login-container">
            <img src="https://lh3.googleusercontent.com/d/1lQ3Babrs3Wgv4rakVmkK0oCWcM0cTKPK" alt="Logo Alkawthar" class="logo">
            <h1 data-lang-key="welcome_title">مرحباً بكم في مكتبة مدارس الكوثر العالمية</h1>
            <p class="welcome-subtitle" data-lang-key="welcome_subtitle">الرجاء إدخال بيانات الاعتماد الخاصة بك للوصول إلى لوحة التحكم.</p>
            <form id="login-form">
                <div class="input-group"><i class="fas fa-user"></i><input type="text" id="username" required data-lang-key-placeholder="username_label"></div>
                <div class="input-group"><i class="fas fa-lock"></i><input type="password" id="password" required data-lang-key-placeholder="password_label"></div>
                <button type="submit" class="btn" data-lang-key="login_btn">تسجيل الدخول</button>
                <p id="login-error" class="error-message"></p>
            </form>
        </div>
    </div>

    <!-- Tableau de bord -->
    <div id="dashboard-page" style="display:none;">
        <header>
             <div class="logo-header"><i class="fas fa-book-open"></i><h1 data-lang-key="dashboard_title">لوحة تحكم مكتبة الكوثر</h1></div>
             <div class="header-controls">
                <div class="language-switcher"><button class="lang-btn" data-lang="ar">AR</button><button class="lang-btn" data-lang="fr">FR</button><button class="lang-btn" data-lang="en">EN</button></div>
                <div class="header-user"><span data-lang-key="school_name">مدارس الكوثر العالمية</span><i class="fas fa-school"></i></div>
                <button id="logout-btn" class="btn-logout"><i class="fas fa-sign-out-alt"></i><span data-lang-key="logout_btn_title">تسجيل الخروج</span></button>
            </div>
        </header>
        <main class="container">
            <section class="card stats-card animated">
                 <h2 data-lang-key="stats_title"><i class="fas fa-chart-pie"></i> إحصائيات المكتبة</h2>
                <div class="stats-container">
                    <div class="stat-item"><i class="fas fa-book"></i><div><span id="total-books-stat">0</span><p data-lang-key="total_books">إجمالي الكتب</p></div></div>
                    <div class="stat-item"><i class="fas fa-hand-holding-heart"></i><div><span id="loaned-books-stat">0</span><p data-lang-key="loaned_books">الكتب المعارة</p></div></div>
                    <div class="stat-item"><i class="fas fa-check-circle"></i><div><span id="available-books-stat">0</span><p data-lang-key="available_books">الكتب المتاحة</p></div></div>
                </div>
                <div style="margin-top: 1rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
                    <button id="view-student-loans-btn" class="btn btn-secondary"><i class="fas fa-user-graduate"></i> <span data-lang-key="view_student_loans_btn">عرض الطلاب المستعيرين</span></button>
                    <button id="view-teacher-loans-btn" class="btn btn-secondary"><i class="fas fa-user-tie"></i> <span data-lang-key="view_teacher_loans_btn">عرض المدرسين المستعيرين</span></button>
                    <button id="export-excel-btn" class="btn btn-success"><i class="fas fa-file-excel"></i> <span data-lang-key="export_excel_btn">تحميل بيانات Excel</span></button>
                </div>
            </section>
            
            <div class="columns">
                <section class="card barcode-section animated">
                    <h2 data-lang-key="scanner_title"><i class="fas fa-barcode"></i> بحث سريع بالباركود</h2>
                    <div class="form-group"><label for="isbn-scanner" data-lang-key="scanner_label">امسح ISBN الكتاب هنا:</label><input type="text" id="isbn-scanner" data-lang-key-placeholder="scanner_placeholder"></div>
                    <div id="book-details-view" class="book-details-view"><p class="placeholder" data-lang-key="scanner_instruction">الرجاء مسح كتاب ضوئياً لعرض معلوماته.</p></div>
                </section>
                <section class="card animated">
                    <h2 data-lang-key="excel_upload_title"><i class="fas fa-file-excel"></i> إضافة عبر ملف Excel</h2>
                    <p data-lang-key="excel_instruction">اختر ملف (.xlsx) بالأعمدة: Title, ISBN, QTY, Subject, level, language, Corner name, Corner number</p>
                    <input type="file" id="excel-file-input" class="file-input" accept=".xlsx, .xls, .csv">
                    <label for="excel-file-input" class="btn btn-secondary file-label" data-lang-key="choose_file_btn"><i class="fas fa-upload"></i> اختر ملف...</label>
                    <button id="upload-excel-btn" class="btn" data-lang-key="upload_btn">رفع الملف</button>
                    <div class="progress-bar-container" style="display: none;">
                        <div class="progress-bar"></div>
                    </div>
                    <div id="upload-status" style="margin-top: 1rem;"></div>
                </section>
            </div>
            
            <section class="card animated">
                <h2 data-lang-key="student_history_title"><i class="fas fa-history"></i> تاريخ الطالب</h2>
                <form id="student-history-form">
                    <div class="form-group">
                        <label for="student-history-search" data-lang-key="student_name_label">اسم الطالب</label>
                        <input type="text" id="student-history-search" required data-lang-key-placeholder="student_history_placeholder">
                    </div>
                    <button type="submit" class="btn btn-secondary"><i class="fas fa-search"></i> <span data-lang-key="search_btn">بحث</span></button>
                </form>
            </section>
            <section class="card animated">
                <h2 data-lang-key="search_book_title"><i class="fas fa-search"></i> البحث في المخزون</h2>
                <div class="form-group"><input type="text" id="search-input" data-lang-key-placeholder="search_placeholder" placeholder="ابحث بالعنوان أو ISBN..."></div>
                <div class="table-container">
                    <table id="books-table">
                        <thead><tr><th data-lang-key="isbn_col">ISBN</th><th data-lang-key="title_col">العنوان</th><th data-lang-key="corner_name_col">اسم الركن</th><th data-lang-key="corner_num_col">رقم الركن</th><th data-lang-key="availability_col">الإتاحة</th><th data-lang-key="actions_col">الإجراءات</th></tr></thead>
                        <tbody id="books-table-body"></tbody>
                    </table>
                </div>
            </section>
            <div class="columns">
                <section class="card animated">
                     <h2 data-lang-key="add_book_title"><i class="fas fa-plus-circle"></i> تسجيل كتاب جديد يدوياً</h2>
                    <form id="add-book-form">
                         <div class="form-group"><label for="new-title" data-lang-key="book_title_label">عنوان الكتاب</label><input type="text" id="new-title" required></div>
                        <div class="form-group"><label for="new-isbn">ISBN</label><input type="text" id="new-isbn" required></div>
                        <div class="form-group"><label for="new-quantity" data-lang-key="quantity_label">الكمية</label><input type="number" id="new-quantity" required min="1" value="1"></div>
                        <div class="form-group"><label for="new-subject" data-lang-key="subject_label">المادة</label><input type="text" id="new-subject"></div>
                        <div class="form-group"><label for="new-level" data-lang-key="level_label">المستوى</label><input type="text" id="new-level"></div>
                        <div class="form-group"><label for="new-language" data-lang-key="language_label">اللغة</label><input type="text" id="new-language"></div>
                        <div class="form-group"><label for="new-corner-name" data-lang-key="corner_name_label">اسم الركن</label><input type="text" id="new-corner-name" required></div>
                        <div class="form-group"><label for="new-corner-number" data-lang-key="corner_num_label">رقم الركن</label><input type="text" id="new-corner-number" required></div>
                        <button type="submit" class="btn" data-lang-key="save_book_btn">حفظ الكتاب</button>
                    </form>
                </section>
                <section class="card animated">
                    <h2 data-lang-key="manage_loan_title"><i class="fas fa-hand-holding-heart"></i> إدارة الإعارة</h2>
                    <form id="loan-form">
                        <div class="form-group"><label for="loan-isbn">ISBN الكتاب</label><input type="text" id="loan-isbn" required></div>
                        <div class="form-group auto-filled"><label data-lang-key="book_title_label">عنوان الكتاب</label><p id="loan-book-title">-</p></div>
                        <hr>
                        <div class="form-group">
                            <label for="borrower-type" data-lang-key="borrower_type_label">نوع المستعير</label>
                            <select id="borrower-type" required>
                                <option value="student" data-lang-key="student_option">طالب</option>
                                <option value="teacher" data-lang-key="teacher_option">مدرس/ة</option>
                            </select>
                        </div>
                        <div class="form-group"><label for="student-name" data-lang-key="borrower_name_label">اسم المستعير</label><input type="text" id="student-name" required></div>
                        <div class="form-group">
                            <label for="student-class" data-lang-key="class_or_subject_label">الفصل/المادة</label>
                            <input type="text" id="student-class" required>
                        </div>
                        <div class="form-group"><label for="loan-date" data-lang-key="loan_date_label">تاريخ الإعارة</label><input type="date" id="loan-date" required></div>
                        <div class="form-group"><label for="return-date" data-lang-key="return_date_label">تاريخ التسليم</label><input type="date" id="return-date" required></div>
                        <button type="submit" class="btn" data-lang-key="loan_book_btn">إعارة الكتاب</button>
                    </form>
                </section>
            </div>
        </main>
        <footer><p data-lang-key="footer_text">&copy; 2025 مدارس الكوثر العالمية - جميع الحقوق محفوظة.</p></footer>
    </div>
    <div id="modal-overlay" class="modal-overlay" style="display:none;">
         <div id="loans-modal" class="modal">
            <button class="close-modal-btn">&times;</button>
            <h2 id="loans-modal-title" data-lang-key="loaned_books_list_title">قائمة الكتب المعارة</h2>
            <div class="form-group"><input type="text" id="loan-search-input" data-lang-key-placeholder="loan_search_placeholder" placeholder="ابحث بالاسم، العنوان، أو امسح ISBN..."></div>
            <div id="loans-modal-content" class="table-container"></div>
        </div>
        <div id="edit-modal" class="modal">
            <button class="close-modal-btn">&times;</button>
            <h2 data-lang-key="edit_book_title">تعديل معلومات الكتاب</h2>
            <form id="edit-book-form">
                <input type="hidden" id="edit-original-isbn">
                <div class="form-group"><label for="edit-title" data-lang-key="book_title_label">عنوان الكتاب</label><input type="text" id="edit-title" required></div>
                <div class="form-group"><label for="edit-isbn">ISBN</label><input type="text" id="edit-isbn" required></div>
                <div class="form-group"><label for="edit-quantity" data-lang-key="quantity_label">الكمية الإجمالية</label><input type="number" id="edit-quantity" required min="1"></div>
                <div class="form-group"><label for="edit-subject" data-lang-key="subject_label">المادة</label><input type="text" id="edit-subject"></div>
                <div class="form-group"><label for="edit-level" data-lang-key="level_label">المستوى</label><input type="text" id="edit-level"></div>
                <div class="form-group"><label for="edit-language" data-lang-key="language_label">اللغة</label><input type="text" id="edit-language"></div>
                <div class="form-group"><label for="edit-corner-name" data-lang-key="corner_name_label">اسم الركن</label><input type="text" id="edit-corner-name" required></div>
                <div class="form-group"><label for="edit-corner-number" data-lang-key="corner_num_label">رقم الركن</label><input type="text" id="edit-corner-number" required></div>
                <button type="submit" class="btn" data-lang-key="save_changes_btn">حفظ التغييرات</button>
            </form>
        </div>
        <div id="history-modal" class="modal">
            <button class="close-modal-btn">&times;</button>
            <h2 id="history-modal-title">Historique</h2>
            <div id="history-modal-content" class="table-container"></div>
        </div>
    </div>
    
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- VARIABLES GLOBALES ---
        let allBooks = [];
        let allLoans = [];

        // --- SÉLECTION DES ÉLÉMENTS DU DOM ---
        const loginPage=document.getElementById("login-page"),dashboardPage=document.getElementById("dashboard-page"),loginForm=document.getElementById("login-form"),loginError=document.getElementById("login-error"),logoutBtn=document.getElementById("logout-btn"),viewLoansBtn=document.getElementById("view-loans-btn"),modalOverlay=document.getElementById("modal-overlay"),loansModal=document.getElementById("loans-modal"),editModal=document.getElementById("edit-modal"),historyModal=document.getElementById("history-modal"),historyModalTitle=document.getElementById("history-modal-title"),historyModalContent=document.getElementById("history-modal-content"),studentHistoryForm=document.getElementById("student-history-form"),addBookForm=document.getElementById("add-book-form"),loanForm=document.getElementById("loan-form"),editBookForm=document.getElementById("edit-book-form"),searchInput=document.getElementById("search-input"),booksTableBody=document.getElementById("books-table-body"),uploadExcelBtn=document.getElementById("upload-excel-btn"),loadingOverlay=document.getElementById("loading-overlay");
        
        // --- FONCTIONS DE COMMUNICATION API ---
        const API_BASE_URL = window.location.hostname.includes('sandbox') ? 'https://3005-iznkr1yjob21txfccaszw-c81df28e.sandbox.novita.ai' : 'http://localhost:3005';
        const apiFetch = async (url, options = {}) => { try { const response = await fetch(`${API_BASE_URL}/api${url}`, options); if (!response.ok) { const errorData = await response.json(); throw new Error(errorData.message || `Erreur HTTP: ${response.status}`); } if (response.status === 204) return; return response.json(); } catch (error) { console.error(`Erreur API pour ${url}:`, error); alert(`Une erreur est survenue: ${error.message}`); throw error; } };

        // --- LOGIQUE DE CHARGEMENT ET SESSION ---
        const showDashboard = () => {
            loginPage.style.display = 'none';
            dashboardPage.style.display = 'block';
            loadAllData();
        };
        
        // Fonction de debounce pour optimiser les recherches
        const debounce = (func, delay) => {
            return function(...args) {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => func.apply(this, args), delay);
            };
        };

        const loadAllData = async () => {
            loadingOverlay.style.display = 'flex';
            try {
                // Chargement optimisé avec cache
                [allBooks, allLoans] = await Promise.all([
                    booksCache ? Promise.resolve(booksCache) : apiFetch('/books'),
                    apiFetch('/loans')
                ]);
                booksCache = allBooks; // Mise en cache des livres
                loansCache = { students: null, teachers: null }; // Reset cache prêts
                initializeDashboard();
            } catch (error) {
                console.error("Impossible de charger les données initiales.");
            } finally {
                loadingOverlay.style.display = 'none';
            }
        };

        // --- FONCTIONS DE MISE À JOUR DE L'INTERFACE ---
        const initializeDashboard = () => {
            updateStats();
            renderTable(allBooks);
        };
        
        const updateStats = () => {
            const totalCopies = allBooks.reduce((sum, book) => sum + (book.totalCopies || 0), 0);
            const loanedCopies = allBooks.reduce((sum, book) => sum + (book.loanedCopies || 0), 0);
            document.getElementById('total-books-stat').textContent = totalCopies;
            document.getElementById('loaned-books-stat').textContent = loanedCopies;
            document.getElementById('available-books-stat').textContent = totalCopies - loanedCopies;
        };
        
        const renderTable = (bookList) => {
             const currentLang = document.documentElement.lang;
             const availabilityTexts = { ar: "متاح", fr: "disponible(s)", en: "available" };
             const actionsTexts = { ar: { edit: "تعديل", delete: "حذف", history: "سجل" }, fr: { edit: "Modifier", delete: "Supprimer", history: "Historique" }, en: { edit: "Edit", delete: "Delete", history: "History" } };
             let tableHTML = '';
             if (bookList) {
                 bookList.forEach(book => {
                     const availableCopies = book.totalCopies - book.loanedCopies;
                     const availabilityClass = availableCopies > 0 ? 'status-available' : 'status-unavailable';
                     const availabilityText = `${availableCopies} / ${book.totalCopies} ${availabilityTexts[currentLang] || availabilityTexts['en']}`;
                     tableHTML += `<tr data-isbn="${book.isbn}">
                        <td>${book.isbn}</td><td>${book.title}</td><td>${book.cornerName||''}</td><td>${book.cornerNumber||''}</td><td><span class="${availabilityClass}">${availabilityText}</span></td>
                        <td class="actions-cell">
                            <button class="btn-action btn-history" title="${actionsTexts[currentLang].history}"><i class="fas fa-history"></i></button>
                            <button class="btn-action btn-edit" title="${actionsTexts[currentLang].edit}"><i class="fas fa-edit"></i></button>
                            <button class="btn-action btn-delete" title="${actionsTexts[currentLang].delete}"><i class="fas fa-trash"></i></button>
                        </td>
                     </tr>`;
                 });
             }
             booksTableBody.innerHTML = tableHTML;
        };

        // --- GESTION DES MODALES ---
        const openModal = (modalElement) => { modalOverlay.style.display = 'flex'; modalElement.style.display = 'flex'; };
        const closeModal = () => { modalOverlay.style.display = 'none'; editModal.style.display = 'none'; loansModal.style.display = 'none'; historyModal.style.display = 'none'; };
        modalOverlay.addEventListener('click', (e) => { if (e.target === modalOverlay) closeModal(); });
        document.querySelectorAll('.close-modal-btn').forEach(btn => btn.addEventListener('click', closeModal));

        const openEditModal = (isbn) => {
            const book = allBooks.find(b => b.isbn === isbn);
            if (!book) return;
            document.getElementById('edit-original-isbn').value = book.isbn;
            document.getElementById('edit-title').value = book.title;
            document.getElementById('edit-isbn').value = book.isbn;
            document.getElementById('edit-quantity').value = book.totalCopies;
            document.getElementById('edit-subject').value = book.subject || '';
            document.getElementById('edit-level').value = book.level || '';
            document.getElementById('edit-language').value = book.language || '';
            document.getElementById('edit-corner-name').value = book.cornerName || '';
            document.getElementById('edit-corner-number').value = book.cornerNumber || '';
            openModal(editModal);
        };
        
        // --- LOGIQUE PRINCIPALE ET ÉVÉNEMENTS ---

        if (localStorage.getItem('isLoggedIn') === 'true') {
            showDashboard();
        } else {
            loginPage.style.display = 'flex';
        }

        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            if (document.getElementById('username').value === 'Alkawthar@30' && document.getElementById('password').value === 'Alkawthar@30') {
                localStorage.setItem('isLoggedIn', 'true');
                showDashboard();
            } else { loginError.textContent = 'اسم المستخدم أو كلمة المرور غير صحيحة.'; }
        });

        logoutBtn.addEventListener('click', () => {
            localStorage.removeItem('isLoggedIn');
            window.location.reload();
        });
        
        // Recherche débouncée pour améliorer les performances
        const debouncedSearch = debounce((searchTerm) => {
            const filteredBooks = searchTerm ? allBooks.filter(book => 
                book.title.toLowerCase().includes(searchTerm) || 
                book.isbn.includes(searchTerm)
            ) : allBooks;
            renderTable(filteredBooks);
        }, 300);
        
        searchInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            debouncedSearch(searchTerm);
        });

        editBookForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const originalIsbn = document.getElementById('edit-original-isbn').value;
            const updatedData = { title:document.getElementById('edit-title').value, isbn:document.getElementById('edit-isbn').value.trim(), totalCopies:parseInt(document.getElementById('edit-quantity').value,10), subject:document.getElementById('edit-subject').value, level:document.getElementById('edit-level').value, language:document.getElementById('edit-language').value, cornerName:document.getElementById('edit-corner-name').value, cornerNumber:document.getElementById('edit-corner-number').value };
            
            try {
                await apiFetch(`/books/${originalIsbn}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(updatedData) });
                const bookIndex = allBooks.findIndex(b => b.isbn === originalIsbn);
                if (bookIndex !== -1) {
                    allBooks[bookIndex] = { ...allBooks[bookIndex], ...updatedData };
                }
                closeModal();
                const currentSearch = searchInput.value.toLowerCase();
                const filteredBooks = !currentSearch ? allBooks : allBooks.filter(book => book.title.toLowerCase().includes(currentSearch) || book.isbn.includes(currentSearch));
                renderTable(filteredBooks);
                updateStats();
            } catch(e) { console.error("La modification a échoué.") }
        });

        booksTableBody.addEventListener('click', (e) => {
            const button = e.target.closest('.btn-action');
            if (!button) return;
            const row = e.target.closest('tr');
            if (!row || !row.dataset.isbn) return;
            const isbn = row.dataset.isbn;
            const book = allBooks.find(b => b.isbn === isbn);
            if (!book) return;

            if (button.classList.contains('btn-edit')) {
                openEditModal(isbn);
            }
            if (button.classList.contains('btn-delete')) {
                if (confirm(`Êtes-vous sûr de vouloir supprimer "${book.title}"?`)) {
                    apiFetch(`/books/${isbn}`, { method: 'DELETE' }).then(() => loadAllData());
                }
            }
            if (button.classList.contains('btn-history')) {
                showBookHistory(isbn, book.title);
            }
        });

         loanForm.addEventListener('submit', async (e) => { e.preventDefault(); const loanData = { isbn: document.getElementById('loan-isbn').value.trim(), studentName: document.getElementById('student-name').value, studentClass: document.getElementById('student-class').value, borrowerType: document.getElementById('borrower-type').value, loanDate: document.getElementById('loan-date').value, returnDate: document.getElementById('return-date').value }; try { await apiFetch('/loans', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(loanData) }); loanForm.reset(); document.getElementById('loan-book-title').textContent = '-'; alert('Livre prêté avec succès!'); await loadAllData(); } catch(error) { console.log("Échec du prêt du livre."); } });
         addBookForm.addEventListener('submit', async (e) => { e.preventDefault(); const bookData = { title: document.getElementById('new-title').value, isbn: document.getElementById('new-isbn').value.trim(), totalCopies: parseInt(document.getElementById('new-quantity').value, 10), subject: document.getElementById('new-subject').value, level: document.getElementById('new-level').value, language: document.getElementById('new-language').value, cornerName: document.getElementById('new-corner-name').value, cornerNumber: document.getElementById('new-corner-number').value }; await apiFetch('/books', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(bookData) }); addBookForm.reset(); await loadAllData(); });
         uploadExcelBtn.addEventListener('click', async () => { const fileInput = document.getElementById('excel-file-input'); const uploadStatus = document.getElementById('upload-status'); const progressBarContainer = document.querySelector('.progress-bar-container'); if (fileInput.files.length === 0) { uploadStatus.textContent = 'الرجاء اختيار ملف.'; return; } const formData = new FormData(); formData.append('excelFile', fileInput.files[0]); progressBarContainer.style.display = 'block'; uploadStatus.textContent = 'جاري رفع ومعالجة الملف...'; uploadStatus.style.color = 'var(--primary-color)'; try { const response = await fetch(`${API_BASE_URL}/api/books/upload`, { method: 'POST', body: formData }); const resultData = await response.json(); if (!response.ok) { throw new Error(resultData.message || 'خطأ غير معروف من الخادم.'); } uploadStatus.textContent = `✅ ${resultData.message} تمت إضافة: ${resultData.addedCount}, تم تجاهل التكرارات: ${resultData.ignoredCount}.`; uploadStatus.style.color = 'green'; fileInput.value = ''; await loadAllData(); } catch (error) { console.error("Erreur lors de l'upload:", error); uploadStatus.textContent = `❌ خطأ: ${error.message}`; uploadStatus.style.color = 'var(--delete-color)'; } finally { progressBarContainer.style.display = 'none'; } });
         const showBookHistory = async (isbn, title) => { historyModalTitle.textContent = `Historique du livre : ${title}`; try { const historyData = await apiFetch(`/history/book/${isbn}`); let content = `<p>Aucun historique trouvé.</p>`; if (historyData.length > 0) { content = `<table id="history-table"><thead><tr><th>Nom de l'élève</th><th>Classe</th><th>Date de prêt</th><th>Date de retour</th></tr></thead><tbody>`; historyData.forEach(entry => { content += `<tr><td>${entry.studentName}</td><td>${entry.studentClass||'-'}</td><td>${new Date(entry.loanDate).toLocaleDateString()}</td><td>${new Date(entry.actualReturnDate).toLocaleDateString()}</td></tr>`; }); content += `</tbody></table>`; } historyModalContent.innerHTML = content; openModal(historyModal); } catch (error) { historyModalContent.innerHTML = `<p>Erreur lors du chargement de l'historique.</p>`; openModal(historyModal); } };
         const showStudentHistory = async (studentName) => { historyModalTitle.textContent = `Historique de l'élève : ${studentName}`; try { const historyData = await apiFetch(`/history/student/${encodeURIComponent(studentName)}`); let content = `<p>Aucun historique trouvé.</p>`; if (historyData.length > 0) { content = `<table id="history-table"><thead><tr><th>Titre du livre</th><th>ISBN</th><th>Date de prêt</th><th>Date de retour</th></tr></thead><tbody>`; historyData.forEach(entry => { content += `<tr><td>${entry.bookTitle}</td><td>${entry.isbn}</td><td>${new Date(entry.loanDate).toLocaleDateString()}</td><td>${new Date(entry.actualReturnDate).toLocaleDateString()}</td></tr>`; }); content += `</tbody></table>`; } historyModalContent.innerHTML = content; openModal(historyModal); } catch (error) { historyModalContent.innerHTML = `<p>Erreur lors du chargement de l'historique.</p>`; openModal(historyModal); } };
         studentHistoryForm.addEventListener('submit', (e) => { e.preventDefault(); const studentName = document.getElementById('student-history-search').value.trim(); if(studentName) { showStudentHistory(studentName); } });
         viewStudentLoansBtn.addEventListener('click', () => { currentLoanType = 'students'; displayLoans('students'); openModal(loansModal); });
         viewTeacherLoansBtn.addEventListener('click', () => { currentLoanType = 'teachers'; displayLoans('teachers'); openModal(loansModal); });
         exportExcelBtn.addEventListener('click', async () => { try { const response = await fetch('/api/export/excel'); const blob = await response.blob(); const url = window.URL.createObjectURL(blob); const a = document.createElement('a'); a.style.display = 'none'; a.href = url; a.download = `library_data_${new Date().toISOString().split('T')[0]}.xlsx`; document.body.appendChild(a); a.click(); window.URL.revokeObjectURL(url); } catch (error) { alert('Erreur lors du téléchargement du fichier Excel'); } });
         const displayLoans = async (loanType = 'students', searchTerm = '') => {
            const loansModalContent = document.getElementById('loans-modal-content');
            try {
                let loans = [];
                if (loanType === 'students') {
                    loans = loansCache.students || await apiFetch('/loans/students');
                    loansCache.students = loans;
                    loansModalTitle.textContent = document.documentElement.lang === 'ar' ? 'قائمة الطلاب المستعيرين' : 'Liste des élèves emprunteurs';
                } else {
                    loans = loansCache.teachers || await apiFetch('/loans/teachers');
                    loansCache.teachers = loans;
                    loansModalTitle.textContent = document.documentElement.lang === 'ar' ? 'قائمة المدرسين المستعيرين' : 'Liste des enseignants emprunteurs';
                }
                
                const lowerCaseSearchTerm = searchTerm.toLowerCase();
                const filteredLoans = loans.filter(loan => (
                    loan.studentName.toLowerCase().includes(lowerCaseSearchTerm) ||
                    (loan.studentClass && loan.studentClass.toLowerCase().includes(lowerCaseSearchTerm)) ||
                    loan.isbn.includes(lowerCaseSearchTerm)
                ));
                
                if (filteredLoans.length === 0) {
                    loansModalContent.innerHTML = `<p style="text-align: center; padding: 1rem;">لا توجد نتائج مطابقة.</p>`;
                    return;
                }
                
                const currentLang = document.documentElement.lang;
                const nameLabel = loanType === 'teachers' ? (
                    { ar: 'اسم المدرس', fr: 'Nom de l\'enseignant', en: 'Teacher Name' }[currentLang]
                ) : ({ ar: 'اسم الطالب', fr: 'Nom de l\'\u00e9l\u00e8ve', en: 'Student Name' }[currentLang]);
                
                const classLabel = loanType === 'teachers' ? (
                    { ar: 'المادة', fr: 'Mati\u00e8re', en: 'Subject' }[currentLang]
                ) : ({ ar: 'الفصل', fr: 'Classe', en: 'Class' }[currentLang]);
                
                const headers = { ar: [nameLabel, classLabel, 'عنوان الكتاب', 'تاريخ الإعارة', 'تاريخ التسليم', 'إجراء'], fr: [nameLabel, classLabel, 'Titre du livre', 'Date d\'emprunt', 'Date de retour', 'Action'], en: [nameLabel, classLabel, 'Book Title', 'Loan Date', 'Return Date', 'Action'] };
                const returnText = { ar: 'إرجاع', fr: 'Retourner', en: 'Return' };
                
                let tableHTML = `<table id="loans-table"><thead><tr><th>${headers[currentLang][0]}</th><th>${headers[currentLang][1]}</th><th>${headers[currentLang][2]}</th><th>${headers[currentLang][3]}</th><th>${headers[currentLang][4]}</th><th>${headers[currentLang][5]}</th></tr></thead><tbody>`;
                
                filteredLoans.forEach(loan => {
                    const book = allBooks.find(b => b.isbn === loan.isbn) || { title: 'Titre non trouv\u00e9' };
                    tableHTML += `<tr>
                        <td>${loan.studentName}</td>
                        <td>${loan.studentClass || '-'}</td>
                        <td>${book.title}</td>
                        <td>${new Date(loan.loanDate).toLocaleDateString()}</td>
                        <td>${new Date(loan.returnDate).toLocaleDateString()}</td>
                        <td><button class="btn-action btn-return" data-isbn="${loan.isbn}" data-student="${loan.studentName}"><i class="fas fa-undo"></i> ${returnText[currentLang]}</button></td>
                    </tr>`;
                });
                
                tableHTML += `</tbody></table>`;
                loansModalContent.innerHTML = tableHTML;
                
                // Attach event listeners for return buttons
                document.querySelectorAll('.btn-return').forEach(button => {
                    button.addEventListener('click', async (e) => {
                        const isbn = e.currentTarget.dataset.isbn;
                        const studentName = e.currentTarget.dataset.student;
                        await returnLoan(isbn, studentName);
                        displayLoans(currentLoanType, document.getElementById('loan-search-input').value);
                    });
                });
            } catch (error) {
                loansModalContent.innerHTML = `<p style="text-align: center; padding: 1rem; color: red;">Erreur lors du chargement des donn\u00e9es.</p>`;
            }
        };, e.currentTarget.dataset.student); }); }); };
         const returnLoan = async (isbn, studentName) => { await apiFetch('/loans', { method: 'DELETE', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ isbn, studentName }) }); await loadAllData(); };
         document.getElementById('loan-search-input').addEventListener('input', (e) => displayLoans(currentLoanType, e.target.value));
         document.getElementById('loan-isbn').addEventListener('input', (e) => { const book = allBooks.find(b => b.isbn === e.target.value.trim()); document.getElementById('loan-book-title').textContent = book ? book.title : '-'; });
         document.getElementById('isbn-scanner').addEventListener('input', (e) => { const book = allBooks.find(b => b.isbn === e.target.value.trim()); document.getElementById('book-details-view').textContent = book ? `Titre: ${book.title} | Disponible: ${book.totalCopies - book.loanedCopies}` : 'Livre non trouvé.'; });
         const fullTranslations = { ar: {title: "مكتبة الكوثر",loading_data: "جاري تحميل البيانات...",class_col: "الفصل",student_class_label: "فصل الطالب", welcome_title: "مرحباً بكم في مكتبة مدارس الكوثر العالمية", welcome_subtitle: "الرجاء إدخال بيانات الاعتماد الخاصة بك للوصول إلى لوحة التحكم.", username_label: "اسم المستخدم", password_label: "كلمة المرور", login_btn: "تسجيل الدخول", dashboard_title: "لوحة تحكم مكتبة الكوثر", school_name: "مدارس الكوثر العالمية", logout_btn_title: "تسجيل الخروج", stats_title: "إحصائيات المكتبة", total_books: "إجمالي الكتب", loaned_books: "الكتب المعارة", available_books: "الكتب المتاحة", scanner_title: "بحث سريع بالباركود", scanner_label: "امسح ISBN الكتاب هنا:", scanner_placeholder: "امسح الباركود...", scanner_instruction: "الرجاء مسح كتاب ضوئياً لعرض معلوماته.", excel_upload_title: "إضافة عبر ملف Excel", excel_instruction: "اختر ملف (.xlsx) بالأعمدة: Title, ISBN, QTY, Subject, level, language, Corner name, Corner number", choose_file_btn: "اختر ملف...", upload_btn: "رفع الملف", search_book_title: "البحث في المخزون", search_placeholder: "ابحث بالعنوان أو ISBN...", isbn_col: "ISBN", title_col: "العنوان", corner_name_col: "اسم الركن", corner_num_col: "رقم الركن", availability_col: "الإتاحة", actions_col: "الإجراءات", add_book_title: "تسجيل كتاب جديد يدوياً", book_title_label: "عنوان الكتاب", save_book_btn: "حفظ الكتاب", manage_loan_title: "إدارة الإعارة", student_name_label: "اسم الطالب", loan_book_btn: "إعارة الكتاب", corner_name_label: "اسم الركن", corner_num_label: "رقم الركن", quantity_label: "الكمية", subject_label: "المادة", level_label: "المستوى", language_label: "اللغة", loan_date_label: "تاريخ الإعارة", return_date_label: "تاريخ التسليم", footer_text: "© 2025 مدارس الكوثر العالمية - جميع الحقوق محفوظة.", view_loans_btn: "عرض الطلاب المستعيرين", loaned_books_list_title: "قائمة الكتب المعارة", edit_book_title: "تعديل معلومات الكتاب", save_changes_btn: "حفظ التغييرات", loan_search_placeholder: "ابحث بالاسم، العنوان، أو امсح ISBN...", student_history_title: "تاريخ الطالب", search_btn: "بحث", student_history_placeholder: "أدخل اسم الطالب للبحث"}, fr: {title: "Bibliothèque Alkawthar",loading_data: "Chargement des données...",class_col: "Classe",student_class_label: "Classe de l'élève", welcome_title: "Bienvenue à la bibliothèque des écoles internationales Alkawthar", welcome_subtitle: "Veuillez saisir vos identifiants pour accéder au tableau de bord.", username_label: "Nom d'utilisateur", password_label: "Mot de passe", login_btn: "Se connecter", dashboard_title: "Tableau de bord de la bibliothèque Alkawthar", school_name: "Écoles Internationales Alkawthar", logout_btn_title: "Se déconnecter", stats_title: "Statistiques de la bibliothèque", total_books: "Total des livres", loaned_books: "Livres prêtés", available_books: "Livres disponibles", scanner_title: "Scan rapide par code-barres", scanner_label: "Scannez l'ISBN du livre ici :", scanner_placeholder: "Scanner le code-barres...", scanner_instruction: "Veuillez scanner un livre pour voir ses informations.", excel_upload_title: "Ajouter via un fichier Excel", excel_instruction: "Choisissez un fichier (.xlsx) avec les colonnes : Title, ISBN, QTY, Subject, level, language, Corner name, Corner number", choose_file_btn: "Choisir un fichier...", upload_btn: "Téléverser le fichier", search_book_title: "Rechercher dans l'inventaire", search_placeholder: "Rechercher par titre ou ISBN...", isbn_col: "ISBN", title_col: "Titre", corner_name_col: "Nom du coin", corner_num_col: "Numéro du coin", availability_col: "Disponibilité", actions_col: "Actions", add_book_title: "Ajouter un nouveau livre manuellement", book_title_label: "Titre du livre", save_book_btn: "Enregistrer le livre", manage_loan_title: "Gérer les prêts", student_name_label: "Nom de l'élève", loan_book_btn: "Prêter le livre", corner_name_label: "Nom du coin", corner_num_label: "Numéro du coin", quantity_label: "Quantité", subject_label: "Matière", level_label: "Niveau", language_label: "Langue", loan_date_label: "Date du prêt", return_date_label: "Date de retour", footer_text: "© 2025 Écoles Internationales Alkawthar - Tous droits réservés.", view_loans_btn: "Voir les élèves emprunteurs", loaned_books_list_title: "Liste des livres prêtés", edit_book_title: "Modifier les informations du livre", save_changes_btn: "Enregistrer les modifications", loan_search_placeholder: "Rechercher par nom, titre ou ISBN...", student_history_title: "Historique de l'élève", search_btn: "Rechercher", student_history_placeholder: "Entrez le nom de l'élève pour rechercher"}, en: {title: "Alkawthar Library",loading_data: "Loading data...",class_col: "Class",student_class_label: "Student's Class", welcome_title: "Welcome to Alkawthar International Schools Library", welcome_subtitle: "Please enter your credentials to access the dashboard.", username_label: "Username", password_label: "Password", login_btn: "Login", dashboard_title: "Alkawthar Library Dashboard", school_name: "Alkawthar International Schools", logout_btn_title: "Logout", stats_title: "Library Statistics", total_books: "Total Books", loaned_books: "Loaned Books", available_books: "Available Books", scanner_title: "Quick Scan by Barcode", scanner_label: "Scan the book's ISBN here:", scanner_placeholder: "Scan barcode...", scanner_instruction: "Please scan a book to view its information.", excel_upload_title: "Add via Excel File", excel_instruction: "Choose an (.xlsx) file with columns: Title, ISBN, QTY, Subject, level, language, Corner name, Corner number", choose_file_btn: "Choose file...", upload_btn: "Upload File", search_book_title: "Search Inventory", search_placeholder: "Search by title or ISBN...", isbn_col: "ISBN", title_col: "Title", corner_name_col: "Corner Name", corner_num_col: "Corner Number", availability_col: "Availability", actions_col: "Actions", add_book_title: "Add a New Book Manually", book_title_label: "Book Title", save_book_btn: "Save Book", manage_loan_title: "Manage Loans", student_name_label: "Student Name", loan_book_btn: "Loan Book", corner_name_label: "Corner Name", corner_num_label: "Corner Number", quantity_label: "Quantity", subject_label: "Subject", level_label: "Level", language_label: "Language", loan_date_label: "Loan Date", return_date_label: "Return Date", footer_text: "© 2025 Alkawthar International Schools - All rights reserved.", view_loans_btn: "View Borrowing Students", loaned_books_list_title: "List of Loaned Books", edit_book_title: "Edit Book Information", save_changes_btn: "Save Changes", loan_search_placeholder: "Search by name, title, or ISBN...", student_history_title: "Student History", search_btn: "Search", student_history_placeholder: "Enter student name to search"} };
         const switchLanguage = (lang) => { document.documentElement.lang = lang; document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr'; document.querySelectorAll('[data-lang-key]').forEach(el => { const key = el.getAttribute('data-lang-key'); if (fullTranslations[lang] && fullTranslations[lang][key]) { el.textContent = fullTranslations[lang][key]; } }); document.querySelectorAll('[data-lang-key-placeholder]').forEach(el => { const key = el.getAttribute('data-lang-key-placeholder'); if (fullTranslations[lang] && fullTranslations[lang][key]) { el.placeholder = fullTranslations[lang][key]; } }); if (dashboardPage.style.display === 'block') { renderTable(allBooks); if (loansModal.style.display === 'flex') { displayLoans(currentLoanType, document.getElementById('loan-search-input').value); } } };
         document.querySelectorAll('.lang-btn').forEach(btn => btn.addEventListener('click', (e) => switchLanguage(e.target.getAttribute('data-lang'))));
         switchLanguage('ar');
    });
    </script>
</body>
</html>
