<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مكتبة الكوثر</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
    <!-- Page de connexion -->
    <div id="login-page" style="display: flex;">
        <div class="login-container">
            <img src="https://lh3.googleusercontent.com/d/1lQ3Babrs3Wgv4rakVmkK0oCWcM0cTKPK" alt="Logo Alkawthar" class="logo">
            <h1>مرحباً بكم في مكتبة مدارس الكوثر العالمية</h1>
            <p class="welcome-subtitle">الرجاء إدخال بيانات الاعتماد الخاصة بك للوصول إلى لوحة التحكم.</p>
            <form id="login-form">
                <div class="input-group">
                    <i class="fas fa-user"></i>
                    <input type="text" id="username" placeholder="اسم المستخدم" required>
                </div>
                <div class="input-group">
                    <i class="fas fa-lock"></i>
                    <input type="password" id="password" placeholder="كلمة المرور" required>
                </div>
                <button type="submit" class="btn">تسجيل الدخول</button>
                <p id="login-error" class="error-message"></p>
            </form>
        </div>
    </div>

    <!-- Tableau de bord -->
    <div id="dashboard-page" style="display:none;">
        <header>
            <div class="logo-header">
                <i class="fas fa-book-open"></i>
                <h1>لوحة تحكم مكتبة الكوثر</h1>
            </div>
            <div class="header-controls">
                <div class="header-user">
                    <span>مدارس الكوثر العالمية</span>
                    <i class="fas fa-school"></i>
                </div>
                <button id="logout-btn" class="btn-logout">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>تسجيل الخروج</span>
                </button>
            </div>
        </header>

        <main class="container">
            <section class="card stats-card animated">
                <h2><i class="fas fa-chart-pie"></i> إحصائيات المكتبة</h2>
                <div class="stats-container">
                    <div class="stat-item">
                        <i class="fas fa-book"></i>
                        <div>
                            <span id="total-books-stat">0</span>
                            <p>إجمالي الكتب</p>
                        </div>
                    </div>
                    <div class="stat-item">
                        <i class="fas fa-hand-holding-heart"></i>
                        <div>
                            <span id="loaned-books-stat">0</span>
                            <p>الكتب المعارة</p>
                        </div>
                    </div>
                    <div class="stat-item">
                        <i class="fas fa-check-circle"></i>
                        <div>
                            <span id="available-books-stat">0</span>
                            <p>الكتب المتاحة</p>
                        </div>
                    </div>
                </div>
                <div style="margin-top: 1rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
                    <button id="view-student-loans-btn" class="btn btn-secondary">
                        <i class="fas fa-user-graduate"></i> 
                        <span>عرض الطلاب المستعيرين</span>
                    </button>
                    <button id="view-teacher-loans-btn" class="btn btn-secondary">
                        <i class="fas fa-user-tie"></i> 
                        <span>عرض المدرسين المستعيرين</span>
                    </button>
                    <button id="export-excel-btn" class="btn btn-success">
                        <i class="fas fa-file-excel"></i> 
                        <span>تحميل بيانات Excel</span>
                    </button>
                </div>
            </section>

            <div class="columns">
                <section class="card animated">
                    <h2><i class="fas fa-plus-circle"></i> إدارة الإعارة</h2>
                    <form id="loan-form">
                        <div class="form-group">
                            <label for="loan-isbn">ISBN الكتاب</label>
                            <input type="text" id="loan-isbn" required>
                        </div>
                        <div class="form-group auto-filled">
                            <label>عنوان الكتاب</label>
                            <p id="loan-book-title">-</p>
                        </div>
                        <div class="form-group">
                            <label for="borrower-type">نوع المستعير</label>
                            <select id="borrower-type" required>
                                <option value="student">طالب</option>
                                <option value="teacher">مدرس/ة</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="student-name">اسم المستعير</label>
                            <input type="text" id="student-name" required>
                        </div>
                        <div class="form-group">
                            <label for="student-class">الفصل/المادة</label>
                            <input type="text" id="student-class" required>
                        </div>
                        <div class="form-group">
                            <label for="loan-date">تاريخ الإعارة</label>
                            <input type="date" id="loan-date" required>
                        </div>
                        <div class="form-group">
                            <label for="return-date">تاريخ التسليم</label>
                            <input type="date" id="return-date" required>
                        </div>
                        <button type="submit" class="btn">إعارة الكتاب</button>
                    </form>
                </section>

                <section class="card animated">
                    <h2><i class="fas fa-book-medical"></i> إضافة كتاب يدوياً</h2>
                    <form id="manual-book-form">
                        <div class="form-group">
                            <label for="manual-isbn">ISBN</label>
                            <input type="text" id="manual-isbn" required>
                        </div>
                        <div class="form-group">
                            <label for="manual-title">عنوان الكتاب</label>
                            <input type="text" id="manual-title" required>
                        </div>
                        <div class="form-group">
                            <label for="manual-copies">عدد النسخ</label>
                            <input type="number" id="manual-copies" min="1" value="1" required>
                        </div>
                        <div class="form-group">
                            <label for="manual-subject">المادة</label>
                            <input type="text" id="manual-subject" placeholder="اختياري">
                        </div>
                        <div class="form-group">
                            <label for="manual-level">المستوى</label>
                            <input type="text" id="manual-level" placeholder="اختياري">
                        </div>
                        <div class="form-group">
                            <label for="manual-language">اللغة</label>
                            <input type="text" id="manual-language" placeholder="اختياري">
                        </div>
                        <div class="form-group">
                            <label for="manual-corner-name">اسم الركن</label>
                            <input type="text" id="manual-corner-name" placeholder="اختياري">
                        </div>
                        <div class="form-group">
                            <label for="manual-corner-number">رقم الركن</label>
                            <input type="text" id="manual-corner-number" placeholder="اختياري">
                        </div>
                        <button type="submit" class="btn btn-primary">إضافة الكتاب</button>
                    </form>
                </section>

                <section class="card animated">
                    <h2><i class="fas fa-file-upload"></i> رفع ملف Excel للكتب</h2>
                    <div class="form-group">
                        <label for="excel-file">اختر ملف Excel</label>
                        <input type="file" id="excel-file" accept=".xlsx,.xls" required>
                    </div>
                    <button id="upload-excel-btn" class="btn btn-success">رفع الملف</button>
                    <div id="upload-status" style="margin-top: 10px;"></div>
                </section>

                <section class="card animated">
                    <h2><i class="fas fa-search"></i> البحث في المخزون</h2>
                    <div class="form-group">
                        <input type="text" id="search-input" placeholder="ابحث بالعنوان أو ISBN...">
                    </div>
                    <div class="table-container">
                        <table id="books-table">
                            <thead>
                                <tr>
                                    <th>ISBN</th>
                                    <th>العنوان</th>
                                    <th>اسم الركن</th>
                                    <th>رقم الركن</th>
                                    <th>الإتاحة</th>
                                </tr>
                            </thead>
                            <tbody id="books-table-body"></tbody>
                        </table>
                    </div>
                </section>
            </div>
        </main>

        <footer>
            <p>&copy; 2025 مدارس الكوثر العالمية - جميع الحقوق محفوظة.</p>
        </footer>
    </div>

    <!-- Modal pour les prêts -->
    <div id="modal-overlay" class="modal-overlay" style="display:none;">
        <div id="loans-modal" class="modal">
            <button class="close-modal-btn">&times;</button>
            <h2 id="loans-modal-title">قائمة الكتب المعارة</h2>
            <div class="form-group">
                <input type="text" id="loan-search-input" placeholder="ابحث بالاسم، العنوان، أو امسح ISBN...">
            </div>
            <div id="loans-modal-content" class="table-container"></div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'https://3002-iznkr1yjob21txfccaszw-c81df28e.sandbox.novita.ai';
        let allBooks = [];
        let allLoans = [];
        let currentLoanType = 'students';

        document.addEventListener('DOMContentLoaded', () => {
            const loginPage = document.getElementById('login-page');
            const dashboardPage = document.getElementById('dashboard-page');
            const loginForm = document.getElementById('login-form');
            const loanForm = document.getElementById('loan-form');
            const searchInput = document.getElementById('search-input');
            const modalOverlay = document.getElementById('modal-overlay');
            const loansModal = document.getElementById('loans-modal');
            
            // Vérifier la session
            if (localStorage.getItem('isLoggedIn') === 'true') {
                showDashboard();
            }

            // Connexion
            loginForm.addEventListener('submit', (e) => {
                e.preventDefault();
                if (document.getElementById('username').value === 'Alkawthar@30' && 
                    document.getElementById('password').value === 'Alkawthar@30') {
                    localStorage.setItem('isLoggedIn', 'true');
                    showDashboard();
                } else {
                    document.getElementById('login-error').textContent = 'اسم المستخدم أو كلمة المرور غير صحيحة.';
                }
            });

            // Déconnexion
            document.getElementById('logout-btn').addEventListener('click', () => {
                localStorage.removeItem('isLoggedIn');
                window.location.reload();
            });

            // Afficher le tableau de bord
            function showDashboard() {
                loginPage.style.display = 'none';
                dashboardPage.style.display = 'block';
                loadAllData();
            }

            // Charger toutes les données
            async function loadAllData() {
                try {
                    const [books, loans] = await Promise.all([
                        fetch(API_BASE_URL + '/api/books').then(r => r.json()),
                        fetch(API_BASE_URL + '/api/loans').then(r => r.json())
                    ]);
                    allBooks = books;
                    allLoans = loans;
                    updateStats();
                    renderTable(allBooks);
                    console.log('Données chargées avec succès:', books.length, 'livres');
                } catch (error) {
                    console.error('Erreur lors du chargement des données:', error);
                }
            }

            // Mettre à jour les statistiques
            function updateStats() {
                const totalCopies = allBooks.reduce((sum, book) => sum + (book.totalCopies || 0), 0);
                const loanedCopies = allBooks.reduce((sum, book) => sum + (book.loanedCopies || 0), 0);
                document.getElementById('total-books-stat').textContent = totalCopies;
                document.getElementById('loaned-books-stat').textContent = loanedCopies;
                document.getElementById('available-books-stat').textContent = totalCopies - loanedCopies;
            }

            // Afficher le tableau des livres
            function renderTable(bookList) {
                let tableHTML = '';
                bookList.forEach(book => {
                    const availableCopies = book.totalCopies - book.loanedCopies;
                    const availabilityClass = availableCopies > 0 ? 'status-available' : 'status-unavailable';
                    const availabilityText = `${availableCopies} / ${book.totalCopies} متاح`;
                    
                    tableHTML += `<tr>
                        <td>${book.isbn}</td>
                        <td>${book.title}</td>
                        <td>${book.cornerName || ''}</td>
                        <td>${book.cornerNumber || ''}</td>
                        <td><span class="${availabilityClass}">${availabilityText}</span></td>
                    </tr>`;
                });
                document.getElementById('books-table-body').innerHTML = tableHTML;
            }

            // Recherche
            searchInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                const filteredBooks = searchTerm ? 
                    allBooks.filter(book => 
                        book.title.toLowerCase().includes(searchTerm) || 
                        book.isbn.includes(searchTerm)
                    ) : allBooks;
                renderTable(filteredBooks);
            });

            // Mise à jour du titre du livre lors de la saisie ISBN
            document.getElementById('loan-isbn').addEventListener('input', (e) => {
                const book = allBooks.find(b => b.isbn === e.target.value.trim());
                document.getElementById('loan-book-title').textContent = book ? book.title : '-';
            });

            // Gestion des prêts
            loanForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const loanData = {
                    isbn: document.getElementById('loan-isbn').value.trim(),
                    studentName: document.getElementById('student-name').value,
                    studentClass: document.getElementById('student-class').value,
                    borrowerType: document.getElementById('borrower-type').value,
                    loanDate: document.getElementById('loan-date').value,
                    returnDate: document.getElementById('return-date').value
                };
                
                try {
                    await fetch(API_BASE_URL + '/api/loans', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(loanData)
                    });
                    loanForm.reset();
                    document.getElementById('loan-book-title').textContent = '-';
                    alert('تم إعارة الكتاب بنجاح!');
                    await loadAllData();
                } catch (error) {
                    alert('خطأ في إعارة الكتاب');
                }
            });

            // Voir les prêts étudiants
            document.getElementById('view-student-loans-btn').addEventListener('click', () => {
                currentLoanType = 'students';
                displayLoans('students');
                openModal(loansModal);
            });

            // Voir les prêts enseignants
            document.getElementById('view-teacher-loans-btn').addEventListener('click', () => {
                currentLoanType = 'teachers';
                displayLoans('teachers');
                openModal(loansModal);
            });

            // Export Excel
            document.getElementById('export-excel-btn').addEventListener('click', async () => {
                try {
                    const response = await fetch(API_BASE_URL + '/api/export/excel');
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    a.download = `library_data_${new Date().toISOString().split('T')[0]}.xlsx`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    alert('تم تحميل ملف Excel بنجاح!');
                } catch (error) {
                    alert('خطأ في تحميل ملف Excel');
                }
            });

            // Manual book addition
            document.getElementById('manual-book-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const bookData = {
                    isbn: document.getElementById('manual-isbn').value,
                    title: document.getElementById('manual-title').value,
                    totalCopies: parseInt(document.getElementById('manual-copies').value),
                    subject: document.getElementById('manual-subject').value || 'Non classé',
                    level: document.getElementById('manual-level').value || 'undefined',
                    language: document.getElementById('manual-language').value || 'Non spécifié',
                    cornerName: document.getElementById('manual-corner-name').value || 'Non classé',
                    cornerNumber: document.getElementById('manual-corner-number').value || '0',
                    loanedCopies: 0
                };
                
                try {
                    const response = await fetch(API_BASE_URL + '/api/books', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(bookData)
                    });
                    
                    if (response.ok) {
                        document.getElementById('manual-book-form').reset();
                        alert('تم إضافة الكتاب بنجاح!');
                        await loadAllData();
                    } else {
                        const error = await response.json();
                        alert('خطأ في إضافة الكتاب: ' + (error.message || 'خطأ غير معروف'));
                    }
                } catch (error) {
                    alert('خطأ في إضافة الكتاب: ' + error.message);
                }
            });

            // Excel file upload
            document.getElementById('upload-excel-btn').addEventListener('click', async () => {
                const fileInput = document.getElementById('excel-file');
                const statusDiv = document.getElementById('upload-status');
                
                if (!fileInput.files[0]) {
                    alert('يرجى اختيار ملف Excel أولاً');
                    return;
                }
                
                const formData = new FormData();
                formData.append('excelFile', fileInput.files[0]);
                
                try {
                    statusDiv.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري رفع الملف...';
                    
                    const response = await fetch(API_BASE_URL + '/api/books/upload', {
                        method: 'POST',
                        body: formData
                    });
                    
                    const result = await response.json();
                    
                    if (response.ok) {
                        statusDiv.innerHTML = `<i class="fas fa-check-circle" style="color: green;"></i> تم رفع الملف بنجاح! تمت إضافة ${result.addedCount} كتاب`;
                        fileInput.value = '';
                        await loadAllData();
                    } else {
                        statusDiv.innerHTML = `<i class="fas fa-exclamation-circle" style="color: red;"></i> خطأ: ${result.message}`;
                    }
                } catch (error) {
                    statusDiv.innerHTML = `<i class="fas fa-exclamation-circle" style="color: red;"></i> خطأ في رفع الملف: ${error.message}`;
                }
            });

            // Afficher les prêts
            async function displayLoans(loanType) {
                const loansModalContent = document.getElementById('loans-modal-content');
                const loansModalTitle = document.getElementById('loans-modal-title');
                
                try {
                    let loans = [];
                    if (loanType === 'students') {
                        loans = await fetch(API_BASE_URL + '/api/loans/students').then(r => r.json());
                        loansModalTitle.textContent = 'قائمة الطلاب المستعيرين';
                    } else {
                        loans = await fetch(API_BASE_URL + '/api/loans/teachers').then(r => r.json());
                        loansModalTitle.textContent = 'قائمة المدرسين المستعيرين';
                    }
                    
                    if (loans.length === 0) {
                        loansModalContent.innerHTML = '<p style="text-align: center; padding: 1rem;">لا توجد نتائج مطابقة.</p>';
                        return;
                    }
                    
                    const nameLabel = loanType === 'teachers' ? 'اسم المدرس' : 'اسم الطالب';
                    const classLabel = loanType === 'teachers' ? 'المادة' : 'الفصل';
                    
                    let tableHTML = `<table id="loans-table">
                        <thead>
                            <tr>
                                <th>${nameLabel}</th>
                                <th>${classLabel}</th>
                                <th>عنوان الكتاب</th>
                                <th>تاريخ الإعارة</th>
                                <th>تاريخ التسليم</th>
                                <th>إجراء</th>
                            </tr>
                        </thead>
                        <tbody>`;
                    
                    loans.forEach(loan => {
                        const book = allBooks.find(b => b.isbn === loan.isbn) || { title: 'عنوان غير محدد' };
                        tableHTML += `<tr>
                            <td>${loan.studentName}</td>
                            <td>${loan.studentClass || '-'}</td>
                            <td>${book.title}</td>
                            <td>${new Date(loan.loanDate).toLocaleDateString()}</td>
                            <td>${new Date(loan.returnDate).toLocaleDateString()}</td>
                            <td>
                                <button class="btn-action btn-return" data-isbn="${loan.isbn}" data-student="${loan.studentName}">
                                    <i class="fas fa-undo"></i> إرجاع
                                </button>
                            </td>
                        </tr>`;
                    });
                    
                    tableHTML += '</tbody></table>';
                    loansModalContent.innerHTML = tableHTML;
                    
                    // Gestion des retours
                    document.querySelectorAll('.btn-return').forEach(button => {
                        button.addEventListener('click', async (e) => {
                            const isbn = e.currentTarget.dataset.isbn;
                            const studentName = e.currentTarget.dataset.student;
                            await returnLoan(isbn, studentName);
                            displayLoans(currentLoanType);
                        });
                    });
                } catch (error) {
                    loansModalContent.innerHTML = '<p style="text-align: center; padding: 1rem; color: red;">خطأ في تحميل البيانات.</p>';
                }
            }

            // Retourner un livre
            async function returnLoan(isbn, studentName) {
                try {
                    await fetch(API_BASE_URL + '/api/loans', {
                        method: 'DELETE',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ isbn, studentName })
                    });
                    await loadAllData();
                    alert('تم إرجاع الكتاب بنجاح!');
                } catch (error) {
                    alert('خطأ في إرجاع الكتاب');
                }
            }

            // Gestion des modales
            function openModal(modalElement) {
                modalOverlay.style.display = 'flex';
                modalElement.style.display = 'flex';
            }

            function closeModal() {
                modalOverlay.style.display = 'none';
                loansModal.style.display = 'none';
            }

            modalOverlay.addEventListener('click', (e) => {
                if (e.target === modalOverlay) closeModal();
            });

            document.querySelectorAll('.close-modal-btn').forEach(btn => 
                btn.addEventListener('click', closeModal)
            );
        });
    </script>
</body>
</html>