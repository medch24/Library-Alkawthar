<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مكتبة الكوثر - Test</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div id="login-page" style="display: flex;">
        <div class="login-container">
            <h1>مرحباً بكم في مكتبة مدارس الكوثر العالمية</h1>
            <form id="login-form">
                <input type="text" id="username" placeholder="اسم المستخدم" required>
                <input type="password" id="password" placeholder="كلمة المرور" required>
                <button type="submit">تسجيل الدخول</button>
            </form>
            <p id="login-error"></p>
        </div>
    </div>

    <div id="dashboard-page" style="display:none;">
        <h1>لوحة تحكم مكتبة الكوثر</h1>
        <div id="stats">
            <p>إجمالي الكتب: <span id="total-books">0</span></p>
            <p>الكتب المعارة: <span id="loaned-books">0</span></p>
            <p>الكتب المتاحة: <span id="available-books">0</span></p>
        </div>
        <button id="view-student-loans-btn">عرض الطلاب المستعيرين</button>
        <button id="view-teacher-loans-btn">عرض المدرسين المستعيرين</button>
        <button id="export-excel-btn">تحميل بيانات Excel</button>
    </div>

    <script>
        const API_BASE_URL = 'https://3005-iznkr1yjob21txfccaszw-c81df28e.sandbox.novita.ai';
        
        document.addEventListener('DOMContentLoaded', () => {
            const loginPage = document.getElementById('login-page');
            const dashboardPage = document.getElementById('dashboard-page');
            const loginForm = document.getElementById('login-form');
            
            // Test API connection
            fetch(API_BASE_URL + '/api/books')
                .then(response => response.json())
                .then(books => {
                    console.log('API connection successful, books:', books.length);
                    document.getElementById('total-books').textContent = books.reduce((sum, book) => sum + book.totalCopies, 0);
                    document.getElementById('loaned-books').textContent = books.reduce((sum, book) => sum + book.loanedCopies, 0);
                    const available = books.reduce((sum, book) => sum + (book.totalCopies - book.loanedCopies), 0);
                    document.getElementById('available-books').textContent = available;
                })
                .catch(error => {
                    console.error('API connection failed:', error);
                    document.getElementById('total-books').textContent = 'Erreur de connexion API';
                });
            
            loginForm.addEventListener('submit', (e) => {
                e.preventDefault();
                if (document.getElementById('username').value === 'Alkawthar@30' && 
                    document.getElementById('password').value === 'Alkawthar@30') {
                    loginPage.style.display = 'none';
                    dashboardPage.style.display = 'block';
                } else {
                    document.getElementById('login-error').textContent = 'اسم المستخدم أو كلمة المرور غير صحيحة';
                }
            });
            
            document.getElementById('view-student-loans-btn').addEventListener('click', async () => {
                try {
                    const response = await fetch(API_BASE_URL + '/api/loans/students');
                    const loans = await response.json();
                    alert(`عدد الطلاب المستعيرين: ${loans.length}`);
                } catch (error) {
                    alert('خطأ في تحميل بيانات الطلاب');
                }
            });
            
            document.getElementById('view-teacher-loans-btn').addEventListener('click', async () => {
                try {
                    const response = await fetch(API_BASE_URL + '/api/loans/teachers');
                    const loans = await response.json();
                    alert(`عدد المدرسين المستعيرين: ${loans.length}`);
                } catch (error) {
                    alert('خطأ في تحميل بيانات المدرسين');
                }
            });
            
            document.getElementById('export-excel-btn').addEventListener('click', async () => {
                try {
                    const response = await fetch(API_BASE_URL + '/api/export/excel');
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `library_data_${new Date().toISOString().split('T')[0]}.xlsx`;
                    a.click();
                    window.URL.revokeObjectURL(url);
                } catch (error) {
                    alert('خطأ في تحميل ملف Excel');
                }
            });
        });
    </script>
</body>
</html>